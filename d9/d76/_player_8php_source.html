<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>PocketMine-MP: Player.php Source File</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="../../PocketMine-h-64.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">PocketMine-MP
   &#160;<span id="projectnumber">Alpha_1.4dev - API 1.0.0</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../dynsections.js"></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../namespaces.html"><span>Packages</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('d9/d76/_player_8php.html','../../');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Player.php</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="comment">/*</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> *  ____            _        _   __  __ _                  __  __ ____  </span>
<a name="l00006"></a>00006 <span class="comment"> * |  _ \ ___   ___| | _____| |_|  \/  (_)_ __   ___      |  \/  |  _ \ </span>
<a name="l00007"></a>00007 <span class="comment"> * | |_) / _ \ / __| |/ / _ \ __| |\/| | | &#39;_ \ / _ \_____| |\/| | |_) |</span>
<a name="l00008"></a>00008 <span class="comment"> * |  __/ (_) | (__|   &lt;  __/ |_| |  | | | | | |  __/_____| |  | |  __/ </span>
<a name="l00009"></a>00009 <span class="comment"> * |_|   \___/ \___|_|\_\___|\__|_|  |_|_|_| |_|\___|     |_|  |_|_| </span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * This program is free software: you can redistribute it and/or modify</span>
<a name="l00012"></a>00012 <span class="comment"> * it under the terms of the GNU Lesser General Public License as published by</span>
<a name="l00013"></a>00013 <span class="comment"> * the Free Software Foundation, either version 3 of the License, or</span>
<a name="l00014"></a>00014 <span class="comment"> * (at your option) any later version.</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * @author PocketMine Team</span>
<a name="l00017"></a>00017 <span class="comment"> * @link http://www.pocketmine.net/</span>
<a name="l00018"></a>00018 <span class="comment"> * </span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment">*/</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="keyword">namespace </span>pocketmine;
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 use pocketmine\block\Block;
<a name="l00025"></a>00025 use pocketmine\command\CommandSender;
<a name="l00026"></a>00026 use pocketmine\entity\DroppedItem;
<a name="l00027"></a>00027 use pocketmine\entity\Human;
<a name="l00028"></a>00028 use pocketmine\event\inventory\InventoryCloseEvent;
<a name="l00029"></a>00029 use pocketmine\event\inventory\InventoryPickupItemEvent;
<a name="l00030"></a>00030 use pocketmine\event\player\PlayerAchievementAwardedEvent;
<a name="l00031"></a>00031 use pocketmine\event\player\PlayerAnimationEvent;
<a name="l00032"></a>00032 use pocketmine\event\player\PlayerChatEvent;
<a name="l00033"></a>00033 use pocketmine\event\player\PlayerCommandPreprocessEvent;
<a name="l00034"></a>00034 use pocketmine\event\player\PlayerDropItemEvent;
<a name="l00035"></a>00035 use pocketmine\event\player\PlayerGameModeChangeEvent;
<a name="l00036"></a>00036 use pocketmine\event\player\PlayerItemConsumeEvent;
<a name="l00037"></a>00037 use pocketmine\event\player\PlayerJoinEvent;
<a name="l00038"></a>00038 use pocketmine\event\player\PlayerKickEvent;
<a name="l00039"></a>00039 use pocketmine\event\player\PlayerLoginEvent;
<a name="l00040"></a>00040 use pocketmine\event\player\PlayerPreLoginEvent;
<a name="l00041"></a>00041 use pocketmine\event\player\PlayerQuitEvent;
<a name="l00042"></a>00042 use pocketmine\event\player\PlayerRespawnEvent;
<a name="l00043"></a>00043 use pocketmine\event\server\DataPacketReceiveEvent;
<a name="l00044"></a>00044 use pocketmine\event\server\DataPacketSendEvent;
<a name="l00045"></a>00045 use pocketmine\inventory\BaseTransaction;
<a name="l00046"></a>00046 use pocketmine\inventory\BigShapelessRecipe;
<a name="l00047"></a>00047 use pocketmine\inventory\CraftingTransactionGroup;
<a name="l00048"></a>00048 use pocketmine\inventory\FurnaceInventory;
<a name="l00049"></a>00049 use pocketmine\inventory\Inventory;
<a name="l00050"></a>00050 use pocketmine\inventory\InventoryHolder;
<a name="l00051"></a>00051 use pocketmine\inventory\SimpleTransactionGroup;
<a name="l00052"></a>00052 use pocketmine\inventory\StonecutterShapelessRecipe;
<a name="l00053"></a>00053 use pocketmine\item\Item;
<a name="l00054"></a>00054 use pocketmine\level\Level;
<a name="l00055"></a>00055 use pocketmine\level\Position;
<a name="l00056"></a>00056 use pocketmine\math\Vector3;
<a name="l00057"></a>00057 use pocketmine\metadata\MetadataValue;
<a name="l00058"></a>00058 use pocketmine\nbt\NBT;
<a name="l00059"></a>00059 use pocketmine\nbt\tag\Byte;
<a name="l00060"></a>00060 use pocketmine\nbt\tag\Compound;
<a name="l00061"></a>00061 use pocketmine\nbt\tag\Int;
<a name="l00062"></a>00062 use pocketmine\nbt\tag\String;
<a name="l00063"></a>00063 use pocketmine\network\protocol\AdventureSettingsPacket;
<a name="l00064"></a>00064 use pocketmine\network\protocol\AnimatePacket;
<a name="l00065"></a>00065 use pocketmine\network\protocol\DataPacket;
<a name="l00066"></a>00066 use pocketmine\network\protocol\EntityEventPacket;
<a name="l00067"></a>00067 use pocketmine\network\protocol\FullChunkDataPacket;
<a name="l00068"></a>00068 use pocketmine\network\protocol\Info as ProtocolInfo;
<a name="l00069"></a>00069 use pocketmine\network\protocol\LoginStatusPacket;
<a name="l00070"></a>00070 use pocketmine\network\protocol\MessagePacket;
<a name="l00071"></a>00071 use pocketmine\network\protocol\MovePlayerPacket;
<a name="l00072"></a>00072 use pocketmine\network\protocol\SetSpawnPositionPacket;
<a name="l00073"></a>00073 use pocketmine\network\protocol\SetTimePacket;
<a name="l00074"></a>00074 use pocketmine\network\protocol\StartGamePacket;
<a name="l00075"></a>00075 use pocketmine\network\protocol\TakeItemEntityPacket;
<a name="l00076"></a>00076 use pocketmine\network\protocol\UnloadChunkPacket;
<a name="l00077"></a>00077 use pocketmine\network\protocol\UpdateBlockPacket;
<a name="l00078"></a>00078 use pocketmine\network\SourceInterface;
<a name="l00079"></a>00079 use pocketmine\permission\PermissibleBase;
<a name="l00080"></a>00080 use pocketmine\permission\PermissionAttachment;
<a name="l00081"></a>00081 use pocketmine\plugin\Plugin;
<a name="l00082"></a>00082 use pocketmine\scheduler\CallbackTask;
<a name="l00083"></a>00083 use pocketmine\tile\Sign;
<a name="l00084"></a>00084 use pocketmine\tile\Spawnable;
<a name="l00085"></a>00085 use pocketmine\tile\Tile;
<a name="l00086"></a>00086 use pocketmine\utils\ReversePriorityQueue;
<a name="l00087"></a>00087 use pocketmine\utils\TextFormat;
<a name="l00088"></a>00088 
<a name="l00092"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html">00092</a> <span class="keyword">class </span><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html">Player</a> <span class="keyword">extends</span> Human implements CommandSender, InventoryHolder, <a class="code" href="../../d1/d6e/interfacepocketmine_1_1_i_player.html">IPlayer</a>{
<a name="l00093"></a>00093 
<a name="l00094"></a>00094     <span class="keyword">const</span> SURVIVAL = 0;
<a name="l00095"></a>00095     <span class="keyword">const</span> CREATIVE = 1;
<a name="l00096"></a>00096     <span class="keyword">const</span> ADVENTURE = 2;
<a name="l00097"></a>00097     <span class="keyword">const</span> SPECTATOR = 3;
<a name="l00098"></a>00098     <span class="keyword">const</span> VIEW = Player::SPECTATOR;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100     <span class="keyword">const</span> MAX_QUEUE = 2048;
<a name="l00101"></a>00101     <span class="keyword">const</span> SURVIVAL_SLOTS = 36;
<a name="l00102"></a>00102     <span class="keyword">const</span> CREATIVE_SLOTS = 112;
<a name="l00103"></a>00103 
<a name="l00105"></a>00105     <span class="keyword">protected</span> $interface;
<a name="l00106"></a>00106 
<a name="l00107"></a>00107     <span class="keyword">public</span> $spawned = <span class="keyword">false</span>;
<a name="l00108"></a>00108     <span class="keyword">public</span> $loggedIn = <span class="keyword">false</span>;
<a name="l00109"></a>00109     <span class="keyword">public</span> $gamemode;
<a name="l00110"></a>00110     <span class="keyword">public</span> $lastBreak;
<a name="l00111"></a>00111 
<a name="l00112"></a>00112     <span class="keyword">protected</span> $windowCnt = 2;
<a name="l00114"></a>00114     <span class="keyword">protected</span> $windows;
<a name="l00116"></a>00116     <span class="keyword">protected</span> $windowIndex = [];
<a name="l00117"></a>00117 
<a name="l00118"></a>00118     <span class="keyword">protected</span> $sendIndex = 0;
<a name="l00119"></a>00119 
<a name="l00120"></a>00120     <span class="keyword">public</span> $blocked = <span class="keyword">true</span>;
<a name="l00121"></a>00121     <span class="keyword">public</span> $achievements = [];
<a name="l00122"></a>00122     <span class="keyword">public</span> $lastCorrect;
<a name="l00124"></a>00124     <span class="keyword">protected</span> $currentTransaction = null;
<a name="l00125"></a>00125     <span class="keyword">public</span> $craftingType = 0; <span class="comment">//0 = 2x2 crafting, 1 = 3x3 crafting, 2 = stonecutter</span>
<a name="l00126"></a>00126 
<a name="l00127"></a>00127     <span class="keyword">protected</span> $isCrafting = <span class="keyword">false</span>;
<a name="l00128"></a>00128     <span class="keyword">public</span> $loginData = [];
<a name="l00129"></a>00129     <span class="keyword">protected</span> $lastMovement = 0;
<a name="l00130"></a>00130     <span class="keyword">protected</span> $forceMovement = <span class="keyword">false</span>;
<a name="l00131"></a>00131     <span class="keyword">protected</span> $connected = <span class="keyword">true</span>;
<a name="l00132"></a>00132     <span class="keyword">protected</span> $clientID;
<a name="l00133"></a>00133     <span class="keyword">protected</span> $ip;
<a name="l00134"></a>00134     <span class="keyword">protected</span> $removeFormat = <span class="keyword">true</span>;
<a name="l00135"></a>00135     <span class="keyword">protected</span> $port;
<a name="l00136"></a>00136     <span class="keyword">protected</span> $username;
<a name="l00137"></a>00137     <span class="keyword">protected</span> $iusername;
<a name="l00138"></a>00138     <span class="keyword">protected</span> $displayName;
<a name="l00139"></a>00139     <span class="keyword">protected</span> $startAction = <span class="keyword">false</span>;
<a name="l00140"></a>00140     <span class="keyword">protected</span> $sleeping = <span class="keyword">false</span>;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142     <span class="keyword">public</span> $usedChunks = [];
<a name="l00143"></a>00143     <span class="keyword">protected</span> $loadQueue = [];
<a name="l00144"></a>00144     <span class="keyword">protected</span> $chunkACK = [];
<a name="l00146"></a>00146     <span class="keyword">protected</span> $chunkLoadTask;
<a name="l00147"></a>00147 
<a name="l00149"></a>00149     <span class="keyword">protected</span> $hiddenPlayers = [];
<a name="l00150"></a>00150 
<a name="l00151"></a>00151     <span class="keyword">private</span> $viewDistance;
<a name="l00152"></a>00152     <span class="keyword">private</span> $spawnPosition;
<a name="l00153"></a>00153     <span class="keyword">private</span> $inAction = <span class="keyword">false</span>;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <span class="keyword">private</span> $needACK = [];
<a name="l00158"></a>00158 
<a name="l00162"></a>00162     <span class="keyword">protected</span> $tasks = [];
<a name="l00163"></a>00163 
<a name="l00165"></a>00165     <span class="keyword">private</span> $perm = null;
<a name="l00166"></a>00166 
<a name="l00167"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a035c4343963288feeff90f7627b5cf2a">00167</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a035c4343963288feeff90f7627b5cf2a">isBanned</a>(){
<a name="l00168"></a>00168         <span class="keywordflow">return</span> $this-&gt;server-&gt;getNameBans()-&gt;isBanned(strtolower($this-&gt;getName()));
<a name="l00169"></a>00169     }
<a name="l00170"></a>00170 
<a name="l00171"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#aed1a076ff87cfda2232224b6140fe1fd">00171</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#aed1a076ff87cfda2232224b6140fe1fd">setBanned</a>($value){
<a name="l00172"></a>00172         <span class="keywordflow">if</span>($value === <span class="keyword">true</span>){
<a name="l00173"></a>00173             $this-&gt;server-&gt;getNameBans()-&gt;addBan($this-&gt;getName(), null, null, null);
<a name="l00174"></a>00174         }<span class="keywordflow">else</span>{
<a name="l00175"></a>00175             $this-&gt;server-&gt;getNameBans()-&gt;remove($this-&gt;getName());
<a name="l00176"></a>00176         }
<a name="l00177"></a>00177     }
<a name="l00178"></a>00178 
<a name="l00179"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a94d504e4583588289e4ea89779259ed1">00179</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a94d504e4583588289e4ea89779259ed1">isWhitelisted</a>(){
<a name="l00180"></a>00180         <span class="keywordflow">return</span> $this-&gt;server-&gt;isWhitelisted(strtolower($this-&gt;getName()));
<a name="l00181"></a>00181     }
<a name="l00182"></a>00182 
<a name="l00183"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ab69bcf805524925755554270e7a97671">00183</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ab69bcf805524925755554270e7a97671">setWhitelisted</a>($value){
<a name="l00184"></a>00184         <span class="keywordflow">if</span>($value === <span class="keyword">true</span>){
<a name="l00185"></a>00185             $this-&gt;server-&gt;addWhitelist(strtolower($this-&gt;getName()));
<a name="l00186"></a>00186         }<span class="keywordflow">else</span>{
<a name="l00187"></a>00187             $this-&gt;server-&gt;removeWhitelist(strtolower($this-&gt;getName()));
<a name="l00188"></a>00188         }
<a name="l00189"></a>00189     }
<a name="l00190"></a>00190 
<a name="l00191"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a6956ebe21be77a0aa9d87639958b88a6">00191</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a6956ebe21be77a0aa9d87639958b88a6">getPlayer</a>(){
<a name="l00192"></a>00192         <span class="keywordflow">return</span> $this;
<a name="l00193"></a>00193     }
<a name="l00194"></a>00194 
<a name="l00195"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ac47b3217573b75d9e9b1f9b409e5a3a2">00195</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ac47b3217573b75d9e9b1f9b409e5a3a2">getFirstPlayed</a>(){
<a name="l00196"></a>00196         <span class="keywordflow">return</span> $this-&gt;namedtag instanceof Compound ? $this-&gt;namedtag[<span class="stringliteral">&quot;firstPlayed&quot;</span>] : null;
<a name="l00197"></a>00197     }
<a name="l00198"></a>00198 
<a name="l00199"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ad8e8652ada97ac3b498d49903521f275">00199</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ad8e8652ada97ac3b498d49903521f275">getLastPlayed</a>(){
<a name="l00200"></a>00200         <span class="keywordflow">return</span> $this-&gt;namedtag instanceof Compound ? $this-&gt;namedtag[<span class="stringliteral">&quot;lastPlayed&quot;</span>] : null;
<a name="l00201"></a>00201     }
<a name="l00202"></a>00202 
<a name="l00203"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#aadd9fa7041114221cf4da808263f5e27">00203</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#aadd9fa7041114221cf4da808263f5e27">hasPlayedBefore</a>(){
<a name="l00204"></a>00204         <span class="keywordflow">return</span> $this-&gt;namedtag instanceof Compound;
<a name="l00205"></a>00205     }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207     <span class="keyword">protected</span> <span class="keyword">function</span> initEntity(){
<a name="l00208"></a>00208         parent::initEntity();
<a name="l00209"></a>00209     }
<a name="l00210"></a>00210 
<a name="l00214"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a64148b8f2640b851c6ad698a4044e8d4">00214</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a64148b8f2640b851c6ad698a4044e8d4">spawnTo</a>(<a class="code" href="../../df/d2c/classpocketmine_1_1_player.html">Player</a> $player){
<a name="l00215"></a>00215         <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">true</span> and $player-&gt;getLevel() === $this-&gt;getLevel() and $player-&gt;<a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a71697b195952a333b72a27f3e0eff6e8">canSee</a>($this)){
<a name="l00216"></a>00216             parent::spawnTo($player);
<a name="l00217"></a>00217         }
<a name="l00218"></a>00218     }
<a name="l00219"></a>00219 
<a name="l00223"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ad3ca35a6d37581802eb5de88ee938c9c">00223</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ad3ca35a6d37581802eb5de88ee938c9c">despawnFrom</a>(<a class="code" href="../../df/d2c/classpocketmine_1_1_player.html">Player</a> $player){
<a name="l00224"></a>00224         <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">true</span>){
<a name="l00225"></a>00225             parent::despawnFrom($player);
<a name="l00226"></a>00226         }
<a name="l00227"></a>00227     }
<a name="l00228"></a>00228 
<a name="l00232"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a6d03d1e69a0e6deea6e05d030da2bd91">00232</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a6d03d1e69a0e6deea6e05d030da2bd91">getServer</a>(){
<a name="l00233"></a>00233         <span class="keywordflow">return</span> $this-&gt;server;
<a name="l00234"></a>00234     }
<a name="l00235"></a>00235 
<a name="l00239"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a9dbd06b750a537c617f73eb5e2700cf7">00239</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a9dbd06b750a537c617f73eb5e2700cf7">getRemoveFormat</a>(){
<a name="l00240"></a>00240         <span class="keywordflow">return</span> $this-&gt;removeFormat;
<a name="l00241"></a>00241     }
<a name="l00242"></a>00242 
<a name="l00246"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ade31a364500c5c6fcc815897b0810e8d">00246</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ade31a364500c5c6fcc815897b0810e8d">setRemoveFormat</a>($remove = <span class="keyword">true</span>){
<a name="l00247"></a>00247         $this-&gt;removeFormat = (bool) $remove;
<a name="l00248"></a>00248     }
<a name="l00249"></a>00249 
<a name="l00255"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a71697b195952a333b72a27f3e0eff6e8">00255</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a71697b195952a333b72a27f3e0eff6e8">canSee</a>(<a class="code" href="../../df/d2c/classpocketmine_1_1_player.html">Player</a> $player){
<a name="l00256"></a>00256         <span class="keywordflow">return</span> !isset($this-&gt;hiddenPlayers[$player-&gt;<a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a890409beec631f5cbc42d602ad94eb2b">getName</a>()]);
<a name="l00257"></a>00257     }
<a name="l00258"></a>00258 
<a name="l00262"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a9c71b41c4af4502ae1a658dd745113e6">00262</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a9c71b41c4af4502ae1a658dd745113e6">hidePlayer</a>(<a class="code" href="../../df/d2c/classpocketmine_1_1_player.html">Player</a> $player){
<a name="l00263"></a>00263         <span class="keywordflow">if</span>($player === $this){
<a name="l00264"></a>00264             <span class="keywordflow">return</span>;
<a name="l00265"></a>00265         }
<a name="l00266"></a>00266         $this-&gt;hiddenPlayers[$player-&gt;<a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a890409beec631f5cbc42d602ad94eb2b">getName</a>()] = $player;
<a name="l00267"></a>00267         $player-&gt;<a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ad3ca35a6d37581802eb5de88ee938c9c">despawnFrom</a>($this);
<a name="l00268"></a>00268     }
<a name="l00269"></a>00269 
<a name="l00273"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a4d2609373c9c8d5a444acb38214031f6">00273</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a4d2609373c9c8d5a444acb38214031f6">showPlayer</a>(<a class="code" href="../../df/d2c/classpocketmine_1_1_player.html">Player</a> $player){
<a name="l00274"></a>00274         <span class="keywordflow">if</span>($player === $this){
<a name="l00275"></a>00275             <span class="keywordflow">return</span>;
<a name="l00276"></a>00276         }
<a name="l00277"></a>00277         unset($this-&gt;hiddenPlayers[$player-&gt;<a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a890409beec631f5cbc42d602ad94eb2b">getName</a>()]);
<a name="l00278"></a>00278         $player-&gt;<a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a64148b8f2640b851c6ad698a4044e8d4">spawnTo</a>($this);
<a name="l00279"></a>00279     }
<a name="l00280"></a>00280 
<a name="l00284"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ad129342e283c32902a928e413a11a136">00284</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ad129342e283c32902a928e413a11a136">isOnline</a>(){
<a name="l00285"></a>00285         <span class="keywordflow">return</span> $this-&gt;connected === <span class="keyword">true</span> and $this-&gt;loggedIn === <span class="keyword">true</span>;
<a name="l00286"></a>00286     }
<a name="l00287"></a>00287 
<a name="l00291"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a8dcfefae09fd5eb3a3e49c7db8db4410">00291</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a8dcfefae09fd5eb3a3e49c7db8db4410">isOp</a>(){
<a name="l00292"></a>00292         <span class="keywordflow">return</span> $this-&gt;server-&gt;isOp($this-&gt;getName());
<a name="l00293"></a>00293     }
<a name="l00294"></a>00294 
<a name="l00298"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a00bc81f14abf88f2e43341cd31fad4cd">00298</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a00bc81f14abf88f2e43341cd31fad4cd">setOp</a>($value){
<a name="l00299"></a>00299         <span class="keywordflow">if</span>($value === $this-&gt;isOp()){
<a name="l00300"></a>00300             <span class="keywordflow">return</span>;
<a name="l00301"></a>00301         }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303         <span class="keywordflow">if</span>($value === <span class="keyword">true</span>){
<a name="l00304"></a>00304             $this-&gt;server-&gt;addOp($this-&gt;getName());
<a name="l00305"></a>00305         }<span class="keywordflow">else</span>{
<a name="l00306"></a>00306             $this-&gt;server-&gt;removeOp($this-&gt;getName());
<a name="l00307"></a>00307         }
<a name="l00308"></a>00308 
<a name="l00309"></a>00309         $this-&gt;recalculatePermissions();
<a name="l00310"></a>00310     }
<a name="l00311"></a>00311 
<a name="l00317"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#af7e35e879f3f69ade39d84ebec97a3d2">00317</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#af7e35e879f3f69ade39d84ebec97a3d2">isPermissionSet</a>($name){
<a name="l00318"></a>00318         <span class="keywordflow">return</span> $this-&gt;perm-&gt;isPermissionSet($name);
<a name="l00319"></a>00319     }
<a name="l00320"></a>00320 
<a name="l00326"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ac6c1a6130ca7d382b05795e58676f2a8">00326</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ac6c1a6130ca7d382b05795e58676f2a8">hasPermission</a>($name){
<a name="l00327"></a>00327         <span class="keywordflow">return</span> $this-&gt;perm-&gt;hasPermission($name);
<a name="l00328"></a>00328     }
<a name="l00329"></a>00329 
<a name="l00337"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a885f59b6fed5b29575cad7c965acfc09">00337</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a885f59b6fed5b29575cad7c965acfc09">addAttachment</a>(Plugin $plugin, $name = null, $value = null){
<a name="l00338"></a>00338         <span class="keywordflow">return</span> $this-&gt;perm-&gt;addAttachment($plugin, $name, $value);
<a name="l00339"></a>00339     }
<a name="l00340"></a>00340 
<a name="l00344"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a042481ae4e522c3e50cf5e094e8a51e5">00344</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a042481ae4e522c3e50cf5e094e8a51e5">removeAttachment</a>(PermissionAttachment $attachment){
<a name="l00345"></a>00345         $this-&gt;perm-&gt;removeAttachment($attachment);
<a name="l00346"></a>00346     }
<a name="l00347"></a>00347 
<a name="l00348"></a>00348     <span class="keyword">public</span> <span class="keyword">function</span> recalculatePermissions(){
<a name="l00349"></a>00349         $this-&gt;server-&gt;getPluginManager()-&gt;unsubscribeFromPermission(Server::BROADCAST_CHANNEL_USERS, $this);
<a name="l00350"></a>00350         $this-&gt;server-&gt;getPluginManager()-&gt;unsubscribeFromPermission(Server::BROADCAST_CHANNEL_ADMINISTRATIVE, $this);
<a name="l00351"></a>00351 
<a name="l00352"></a>00352         $this-&gt;perm-&gt;recalculatePermissions();
<a name="l00353"></a>00353 
<a name="l00354"></a>00354         <span class="keywordflow">if</span>($this-&gt;hasPermission(Server::BROADCAST_CHANNEL_USERS)){
<a name="l00355"></a>00355             $this-&gt;server-&gt;getPluginManager()-&gt;subscribeToPermission(Server::BROADCAST_CHANNEL_USERS, $this);
<a name="l00356"></a>00356         }
<a name="l00357"></a>00357         <span class="keywordflow">if</span>($this-&gt;hasPermission(Server::BROADCAST_CHANNEL_ADMINISTRATIVE)){
<a name="l00358"></a>00358             $this-&gt;server-&gt;getPluginManager()-&gt;subscribeToPermission(Server::BROADCAST_CHANNEL_ADMINISTRATIVE, $this);
<a name="l00359"></a>00359         }
<a name="l00360"></a>00360     }
<a name="l00361"></a>00361 
<a name="l00365"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ac614ff040d24b173fb080166f2d121f6">00365</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ac614ff040d24b173fb080166f2d121f6">getEffectivePermissions</a>(){
<a name="l00366"></a>00366         <span class="keywordflow">return</span> $this-&gt;perm-&gt;getEffectivePermissions();
<a name="l00367"></a>00367     }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369 
<a name="l00376"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a4cda231053a2c4e8ca15d57c06aff1ef">00376</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a4cda231053a2c4e8ca15d57c06aff1ef">__construct</a>(SourceInterface $interface, $clientID, $ip, $port){
<a name="l00377"></a>00377         $this-&gt;<span class="keyword">interface </span>= $interface;
<a name="l00378"></a>00378         $this-&gt;windows = new \SplObjectStorage();
<a name="l00379"></a>00379         $this-&gt;perm = <span class="keyword">new</span> PermissibleBase($this);
<a name="l00380"></a>00380         $this-&gt;namedtag = <span class="keyword">new</span> Compound();
<a name="l00381"></a>00381         $this-&gt;server = Server::getInstance();
<a name="l00382"></a>00382         $this-&gt;lastBreak = microtime(<span class="keyword">true</span>);
<a name="l00383"></a>00383         $this-&gt;clientID = $clientID;
<a name="l00384"></a>00384         $this-&gt;ip = $ip;
<a name="l00385"></a>00385         $this-&gt;port = $port;
<a name="l00386"></a>00386         $this-&gt;spawnPosition = $this-&gt;server-&gt;getDefaultLevel()-&gt;getSafeSpawn();
<a name="l00387"></a>00387         $this-&gt;timeout = microtime(<span class="keyword">true</span>) + 20;
<a name="l00388"></a>00388         $this-&gt;gamemode = $this-&gt;server-&gt;getGamemode();
<a name="l00389"></a>00389         $this-&gt;setLevel($this-&gt;server-&gt;getDefaultLevel(), <span class="keyword">true</span>);
<a name="l00390"></a>00390         $this-&gt;viewDistance = $this-&gt;server-&gt;getViewDistance();
<a name="l00391"></a>00391 
<a name="l00392"></a>00392         $this-&gt;server-&gt;getLogger()-&gt;debug(<span class="stringliteral">&quot;New Session started with &quot;</span> . $ip . <span class="stringliteral">&quot;:&quot;</span> . $port . <span class="stringliteral">&quot;, Client ID &quot;</span> . $this-&gt;clientID);
<a name="l00393"></a>00393     }
<a name="l00394"></a>00394 
<a name="l00398"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ad527b9ec2468818b3558428e5c7f05ae">00398</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ad527b9ec2468818b3558428e5c7f05ae">removeAchievement</a>($achievementId){
<a name="l00399"></a>00399         <span class="keywordflow">if</span>($this-&gt;hasAchievement($achievementId)){
<a name="l00400"></a>00400             $this-&gt;achievements[$achievementId] = <span class="keyword">false</span>;
<a name="l00401"></a>00401         }
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403 
<a name="l00409"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a4453a8c4c889ee0f5513716a8e380f7b">00409</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a4453a8c4c889ee0f5513716a8e380f7b">hasAchievement</a>($achievementId){
<a name="l00410"></a>00410         <span class="keywordflow">if</span>(!isset(Achievement::$list[$achievementId]) or !isset($this-&gt;achievements)){
<a name="l00411"></a>00411             $this-&gt;achievements = [];
<a name="l00412"></a>00412 
<a name="l00413"></a>00413             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00414"></a>00414         }
<a name="l00415"></a>00415 
<a name="l00416"></a>00416         <span class="keywordflow">if</span>(!isset($this-&gt;achievements[$achievementId]) or $this-&gt;achievements[$achievementId] == <span class="keyword">false</span>){
<a name="l00417"></a>00417             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00418"></a>00418         }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00421"></a>00421     }
<a name="l00422"></a>00422 
<a name="l00426"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a4a7c75b930d02d4f0d499eb5e5e6e7a2">00426</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a4a7c75b930d02d4f0d499eb5e5e6e7a2">isConnected</a>(){
<a name="l00427"></a>00427         <span class="keywordflow">return</span> $this-&gt;connected === <span class="keyword">true</span>;
<a name="l00428"></a>00428     }
<a name="l00429"></a>00429 
<a name="l00435"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a8cf4b66f84f50f37ff202921078314a8">00435</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a8cf4b66f84f50f37ff202921078314a8">getDisplayName</a>(){
<a name="l00436"></a>00436         <span class="keywordflow">return</span> $this-&gt;displayName;
<a name="l00437"></a>00437     }
<a name="l00438"></a>00438 
<a name="l00442"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a4b025a09d927d42343a4b952220e9777">00442</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a4b025a09d927d42343a4b952220e9777">setDisplayName</a>($name){
<a name="l00443"></a>00443         $this-&gt;displayName = $name;
<a name="l00444"></a>00444     }
<a name="l00445"></a>00445 
<a name="l00449"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a366faeb6131badea169448c98499ec25">00449</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a366faeb6131badea169448c98499ec25">getNameTag</a>(){
<a name="l00450"></a>00450         <span class="keywordflow">return</span> $this-&gt;nameTag;
<a name="l00451"></a>00451     }
<a name="l00452"></a>00452 
<a name="l00456"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#aeba3755ffbc2fa5779e1ce62ee1f2c14">00456</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#aeba3755ffbc2fa5779e1ce62ee1f2c14">setNameTag</a>($name){
<a name="l00457"></a>00457         $this-&gt;nameTag = $name;
<a name="l00458"></a>00458         $this-&gt;despawnFromAll();
<a name="l00459"></a>00459         <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">true</span>){
<a name="l00460"></a>00460             $this-&gt;spawnToAll();
<a name="l00461"></a>00461         }
<a name="l00462"></a>00462     }
<a name="l00463"></a>00463 
<a name="l00469"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a813a79221b9f51a6ef6f2b5de416735f">00469</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a813a79221b9f51a6ef6f2b5de416735f">getAddress</a>(){
<a name="l00470"></a>00470         <span class="keywordflow">return</span> $this-&gt;ip;
<a name="l00471"></a>00471     }
<a name="l00472"></a>00472 
<a name="l00476"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a5697e068c73b84615dcae1cc02ed8354">00476</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a5697e068c73b84615dcae1cc02ed8354">getPort</a>(){
<a name="l00477"></a>00477         <span class="keywordflow">return</span> $this-&gt;port;
<a name="l00478"></a>00478     }
<a name="l00479"></a>00479 
<a name="l00483"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a33543cf14cfb0deacc6db5e9a9447e1e">00483</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a33543cf14cfb0deacc6db5e9a9447e1e">isSleeping</a>(){
<a name="l00484"></a>00484         <span class="keywordflow">return</span> $this-&gt;sleeping instanceof Vector3;
<a name="l00485"></a>00485     }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487     <span class="keyword">public</span> <span class="keyword">function</span> unloadChunk($x, $z){
<a name="l00488"></a>00488         $index = Level::chunkHash($x, $z);
<a name="l00489"></a>00489         <span class="keywordflow">if</span>(isset($this-&gt;usedChunks[$index])){
<a name="l00490"></a>00490             <span class="keywordflow">foreach</span>($this-&gt;getLevel()-&gt;getChunkEntities($x, $z) as $entity){
<a name="l00491"></a>00491                 <span class="keywordflow">if</span>($entity !== $this){
<a name="l00492"></a>00492                     $entity-&gt;despawnFrom($this);
<a name="l00493"></a>00493                 }
<a name="l00494"></a>00494             }
<a name="l00495"></a>00495             $pk = <span class="keyword">new</span> UnloadChunkPacket();
<a name="l00496"></a>00496             $pk-&gt;chunkX = $x;
<a name="l00497"></a>00497             $pk-&gt;chunkZ = $z;
<a name="l00498"></a>00498             $this-&gt;dataPacket($pk);
<a name="l00499"></a>00499             unset($this-&gt;usedChunks[$index]);
<a name="l00500"></a>00500         }
<a name="l00501"></a>00501         unset($this-&gt;loadQueue[$index]);
<a name="l00502"></a>00502         $this-&gt;orderChunks();
<a name="l00503"></a>00503     }
<a name="l00504"></a>00504 
<a name="l00508"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#add2b28b141c236147f87430228dbd632">00508</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#add2b28b141c236147f87430228dbd632">getSpawn</a>(){
<a name="l00509"></a>00509         <span class="keywordflow">return</span> $this-&gt;spawnPosition;
<a name="l00510"></a>00510     }
<a name="l00511"></a>00511 
<a name="l00517"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#aa36f11156b4dc283621b459769bbcc75">00517</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#aa36f11156b4dc283621b459769bbcc75">checkACK</a>($identifier){
<a name="l00518"></a>00518         <span class="keywordflow">return</span> !isset($this-&gt;needACK[$identifier]);
<a name="l00519"></a>00519     }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521     <span class="keyword">public</span> <span class="keyword">function</span> handleACK($identifier){
<a name="l00522"></a>00522         unset($this-&gt;needACK[$identifier]);
<a name="l00523"></a>00523         <span class="keywordflow">if</span>(isset($this-&gt;chunkACK[$identifier])){
<a name="l00524"></a>00524             $index = $this-&gt;chunkACK[$identifier];
<a name="l00525"></a>00525             unset($this-&gt;chunkACK[$identifier]);
<a name="l00526"></a>00526             <span class="keywordflow">if</span>(isset($this-&gt;usedChunks[$index])){
<a name="l00527"></a>00527                 $this-&gt;usedChunks[$index][0] = <span class="keyword">true</span>;
<a name="l00528"></a>00528                 $X = null;
<a name="l00529"></a>00529                 $Z = null;
<a name="l00530"></a>00530                 Level::getXZ($index, $X, $Z);
<a name="l00531"></a>00531 
<a name="l00532"></a>00532                 <span class="keywordflow">foreach</span>($this-&gt;getLevel()-&gt;getChunkEntities($X, $Z) as $entity){
<a name="l00533"></a>00533                     <span class="keywordflow">if</span>($entity !== $this){
<a name="l00534"></a>00534                         $entity-&gt;spawnTo($this);
<a name="l00535"></a>00535                     }
<a name="l00536"></a>00536                 }
<a name="l00537"></a>00537             }
<a name="l00538"></a>00538         }
<a name="l00539"></a>00539     }
<a name="l00540"></a>00540 
<a name="l00549"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a6d56c71a3ea8ecd88592937e098fdae9">00549</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a6d56c71a3ea8ecd88592937e098fdae9">sendNextChunk</a>(){
<a name="l00550"></a>00550         <span class="keywordflow">if</span>($this-&gt;connected === <span class="keyword">false</span> or !isset($this-&gt;chunkLoadTask)){
<a name="l00551"></a>00551             <span class="keywordflow">return</span>;
<a name="l00552"></a>00552         }
<a name="l00553"></a>00553 
<a name="l00554"></a>00554         <span class="keywordflow">if</span>(count($this-&gt;loadQueue) === 0){
<a name="l00555"></a>00555             $this-&gt;chunkLoadTask-&gt;setNextRun($this-&gt;chunkLoadTask-&gt;getNextRun() + 30);
<a name="l00556"></a>00556         }<span class="keywordflow">else</span>{
<a name="l00557"></a>00557             $count = 0;
<a name="l00558"></a>00558             $limit = (int) $this-&gt;server-&gt;getProperty(<span class="stringliteral">&quot;chunk-sending.per-tick&quot;</span>, 1);
<a name="l00559"></a>00559             <span class="keywordflow">foreach</span>($this-&gt;loadQueue as $index =&gt; $distance){
<a name="l00560"></a>00560                 <span class="keywordflow">if</span>($count &gt;= $limit){
<a name="l00561"></a>00561                     <span class="keywordflow">break</span>;
<a name="l00562"></a>00562                 }
<a name="l00563"></a>00563                 ++$count;
<a name="l00564"></a>00564                 $X = null;
<a name="l00565"></a>00565                 $Z = null;
<a name="l00566"></a>00566                 Level::getXZ($index, $X, $Z);
<a name="l00567"></a>00567                 <span class="keywordflow">if</span>(!$this-&gt;getLevel()-&gt;isChunkPopulated($X, $Z)){
<a name="l00568"></a>00568                     $this-&gt;chunkLoadTask-&gt;setNextRun($this-&gt;chunkLoadTask-&gt;getNextRun() + 30);
<a name="l00569"></a>00569                     <span class="keywordflow">return</span>;
<a name="l00570"></a>00570                 }
<a name="l00571"></a>00571 
<a name="l00572"></a>00572                 unset($this-&gt;loadQueue[$index]);
<a name="l00573"></a>00573                 $this-&gt;usedChunks[$index] = [<span class="keyword">false</span>, 0];
<a name="l00574"></a>00574 
<a name="l00575"></a>00575                 $this-&gt;getLevel()-&gt;useChunk($X, $Z, $this);
<a name="l00576"></a>00576                 $pk = <span class="keyword">new</span> FullChunkDataPacket;
<a name="l00577"></a>00577                 $pk-&gt;chunkX = $X;
<a name="l00578"></a>00578                 $pk-&gt;chunkZ = $Z;
<a name="l00579"></a>00579                 $pk-&gt;data = $this-&gt;getLevel()-&gt;getNetworkChunk($X, $Z, 0xff);
<a name="l00580"></a>00580                 $cnt = $this-&gt;dataPacket($pk, <span class="keyword">true</span>);
<a name="l00581"></a>00581                 <span class="keywordflow">if</span>($cnt === <span class="keyword">false</span> or $cnt === <span class="keyword">true</span>){
<a name="l00582"></a>00582                     <span class="keywordflow">return</span>;
<a name="l00583"></a>00583                 }
<a name="l00584"></a>00584                 $this-&gt;chunkACK[$cnt] = $index;
<a name="l00585"></a>00585             }
<a name="l00586"></a>00586         }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588         <span class="keywordflow">if</span>(count($this-&gt;usedChunks) &lt; 8 and $this-&gt;spawned === <span class="keyword">true</span>){
<a name="l00589"></a>00589             $this-&gt;blocked = <span class="keyword">true</span>;
<a name="l00590"></a>00590         }elseif($this-&gt;spawned === <span class="keyword">true</span>){
<a name="l00591"></a>00591             $this-&gt;blocked = <span class="keyword">false</span>;
<a name="l00592"></a>00592         }
<a name="l00593"></a>00593 
<a name="l00594"></a>00594         <span class="keywordflow">if</span>(count($this-&gt;usedChunks) &gt;= 56 and $this-&gt;spawned === <span class="keyword">false</span>){
<a name="l00595"></a>00595             $spawned = 0;
<a name="l00596"></a>00596             <span class="keywordflow">foreach</span>($this-&gt;usedChunks as $d){
<a name="l00597"></a>00597                 <span class="keywordflow">if</span>($d[0] === <span class="keyword">true</span>){
<a name="l00598"></a>00598                     $spawned++;
<a name="l00599"></a>00599                 }
<a name="l00600"></a>00600             }
<a name="l00601"></a>00601 
<a name="l00602"></a>00602             <span class="keywordflow">if</span>($spawned &lt; 56){
<a name="l00603"></a>00603                 <span class="keywordflow">return</span>;
<a name="l00604"></a>00604             }
<a name="l00605"></a>00605 
<a name="l00606"></a>00606             <span class="comment">//TODO</span>
<a name="l00607"></a>00607             <span class="comment">//$this-&gt;heal($this-&gt;data-&gt;get(&quot;health&quot;), &quot;spawn&quot;, true);</span>
<a name="l00608"></a>00608             $this-&gt;spawned = <span class="keyword">true</span>;
<a name="l00609"></a>00609 
<a name="l00610"></a>00610             $this-&gt;sendSettings();
<a name="l00611"></a>00611             $this-&gt;inventory-&gt;sendContents($this);
<a name="l00612"></a>00612             $this-&gt;inventory-&gt;sendArmorContents($this);
<a name="l00613"></a>00613 
<a name="l00614"></a>00614             $this-&gt;blocked = <span class="keyword">false</span>;
<a name="l00615"></a>00615 
<a name="l00616"></a>00616             $pk = <span class="keyword">new</span> SetTimePacket;
<a name="l00617"></a>00617             $pk-&gt;time = $this-&gt;getLevel()-&gt;getTime();
<a name="l00618"></a>00618             $pk-&gt;started = $this-&gt;getLevel()-&gt;stopTime == <span class="keyword">false</span>;
<a name="l00619"></a>00619             $this-&gt;dataPacket($pk);
<a name="l00620"></a>00620 
<a name="l00621"></a>00621             $pos = <span class="keyword">new</span> Position($this-&gt;x, $this-&gt;y, $this-&gt;z, $this-&gt;getLevel());
<a name="l00622"></a>00622             $pos = $this-&gt;getLevel()-&gt;getSafeSpawn($pos);
<a name="l00623"></a>00623 
<a name="l00624"></a>00624             $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev = <span class="keyword">new</span> PlayerRespawnEvent($this, $pos));
<a name="l00625"></a>00625 
<a name="l00626"></a>00626             $this-&gt;teleport($ev-&gt;getRespawnPosition());
<a name="l00627"></a>00627 
<a name="l00628"></a>00628             $this-&gt;spawnToAll();
<a name="l00629"></a>00629 
<a name="l00630"></a>00630             $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev = <span class="keyword">new</span> PlayerJoinEvent($this, TextFormat::YELLOW . $this-&gt;getName() . <span class="stringliteral">&quot; joined the game&quot;</span>));
<a name="l00631"></a>00631             <span class="keywordflow">if</span>(strlen(trim($ev-&gt;getJoinMessage())) &gt; 0){
<a name="l00632"></a>00632                 $this-&gt;server-&gt;broadcastMessage($ev-&gt;getJoinMessage());
<a name="l00633"></a>00633             }
<a name="l00634"></a>00634 
<a name="l00635"></a>00635             <span class="keywordflow">if</span>($this-&gt;server-&gt;getUpdater()-&gt;hasUpdate() and $this-&gt;hasPermission(Server::BROADCAST_CHANNEL_ADMINISTRATIVE)){
<a name="l00636"></a>00636                 $this-&gt;server-&gt;getUpdater()-&gt;showPlayerUpdate($this);
<a name="l00637"></a>00637             }
<a name="l00638"></a>00638         }
<a name="l00639"></a>00639     }
<a name="l00640"></a>00640 
<a name="l00648"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a8add13563956b032542c699cd7281158">00648</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a8add13563956b032542c699cd7281158">orderChunks</a>(){
<a name="l00649"></a>00649         <span class="keywordflow">if</span>($this-&gt;connected === <span class="keyword">false</span>){
<a name="l00650"></a>00650             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00651"></a>00651         }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653         $newOrder = [];
<a name="l00654"></a>00654         $lastChunk = $this-&gt;usedChunks;
<a name="l00655"></a>00655         $centerX = $this-&gt;x &gt;&gt; 4;
<a name="l00656"></a>00656         $centerZ = $this-&gt;z &gt;&gt; 4;
<a name="l00657"></a>00657         $startX = $centerX - $this-&gt;viewDistance;
<a name="l00658"></a>00658         $startZ = $centerZ - $this-&gt;viewDistance;
<a name="l00659"></a>00659         $finalX = $centerX + $this-&gt;viewDistance;
<a name="l00660"></a>00660         $finalZ = $centerZ + $this-&gt;viewDistance;
<a name="l00661"></a>00661         $generateQueue = <span class="keyword">new</span> ReversePriorityQueue();
<a name="l00662"></a>00662         <span class="keywordflow">for</span>($X = $startX; $X &lt;= $finalX; ++$X){
<a name="l00663"></a>00663             <span class="keywordflow">for</span>($Z = $startZ; $Z &lt;= $finalZ; ++$Z){
<a name="l00664"></a>00664                 $distance = abs($X - $centerX) + abs($Z - $centerZ);
<a name="l00665"></a>00665                 $index = Level::chunkHash($X, $Z);
<a name="l00666"></a>00666                 <span class="keywordflow">if</span>(!isset($this-&gt;usedChunks[$index])){
<a name="l00667"></a>00667                     <span class="keywordflow">if</span>($this-&gt;getLevel()-&gt;isChunkPopulated($X, $Z)){
<a name="l00668"></a>00668                         $newOrder[$index] = $distance;
<a name="l00669"></a>00669                     }<span class="keywordflow">else</span>{
<a name="l00670"></a>00670                         $generateQueue-&gt;insert([$X, $Z], $distance);
<a name="l00671"></a>00671                     }
<a name="l00672"></a>00672                 }
<a name="l00673"></a>00673                 unset($lastChunk[$index]);
<a name="l00674"></a>00674             }
<a name="l00675"></a>00675         }
<a name="l00676"></a>00676 
<a name="l00677"></a>00677         asort($newOrder);
<a name="l00678"></a>00678         $this-&gt;loadQueue = $newOrder;
<a name="l00679"></a>00679 
<a name="l00680"></a>00680         $i = 0;
<a name="l00681"></a>00681         <span class="keywordflow">while</span>(count($this-&gt;loadQueue) &lt; 3 and $generateQueue-&gt;count() &gt; 0 and $i &lt; 16){
<a name="l00682"></a>00682             $d = $generateQueue-&gt;extract();
<a name="l00683"></a>00683             $this-&gt;getLevel()-&gt;generateChunk($d[0], $d[1]);
<a name="l00684"></a>00684             ++$i;
<a name="l00685"></a>00685         }
<a name="l00686"></a>00686 
<a name="l00687"></a>00687 
<a name="l00688"></a>00688         <span class="keywordflow">foreach</span>($lastChunk as $index =&gt; $Yndex){
<a name="l00689"></a>00689             $X = null;
<a name="l00690"></a>00690             $Z = null;
<a name="l00691"></a>00691             Level::getXZ($index, $X, $Z);
<a name="l00692"></a>00692             <span class="keywordflow">foreach</span>($this-&gt;getLevel()-&gt;getChunkEntities($X, $Z) as $entity){
<a name="l00693"></a>00693                 <span class="keywordflow">if</span>($entity !== $this){
<a name="l00694"></a>00694                     $entity-&gt;despawnFrom($this);
<a name="l00695"></a>00695                 }
<a name="l00696"></a>00696             }
<a name="l00697"></a>00697             $pk = <span class="keyword">new</span> UnloadChunkPacket();
<a name="l00698"></a>00698             $pk-&gt;chunkX = $X;
<a name="l00699"></a>00699             $pk-&gt;chunkZ = $Z;
<a name="l00700"></a>00700             $this-&gt;dataPacket($pk);
<a name="l00701"></a>00701             unset($this-&gt;usedChunks[$index]);
<a name="l00702"></a>00702         }
<a name="l00703"></a>00703     }
<a name="l00704"></a>00704 
<a name="l00713"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a1c8bc00d964b5059917eaeeb4478245b">00713</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a1c8bc00d964b5059917eaeeb4478245b">dataPacket</a>(DataPacket $packet, $needACK = <span class="keyword">false</span>){
<a name="l00714"></a>00714         <span class="keywordflow">if</span>($this-&gt;connected === <span class="keyword">false</span>){
<a name="l00715"></a>00715             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00716"></a>00716         }
<a name="l00717"></a>00717         $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev = <span class="keyword">new</span> DataPacketSendEvent($this, $packet));
<a name="l00718"></a>00718         <span class="keywordflow">if</span>($ev-&gt;isCancelled()){
<a name="l00719"></a>00719             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00720"></a>00720         }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722         $identifier = $this-&gt;interface-&gt;putPacket($this, $packet, $needACK, <span class="keyword">false</span>);
<a name="l00723"></a>00723 
<a name="l00724"></a>00724         <span class="keywordflow">if</span>($needACK and $identifier !== null){
<a name="l00725"></a>00725             $this-&gt;needACK[$identifier] = <span class="keyword">false</span>;
<a name="l00726"></a>00726 
<a name="l00727"></a>00727             <span class="keywordflow">return</span> $identifier;
<a name="l00728"></a>00728         }
<a name="l00729"></a>00729 
<a name="l00730"></a>00730         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00731"></a>00731     }
<a name="l00732"></a>00732 
<a name="l00739"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ae7d9777b9607f7d73a1df4a65fa03c8d">00739</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ae7d9777b9607f7d73a1df4a65fa03c8d">directDataPacket</a>(DataPacket $packet, $needACK = <span class="keyword">false</span>){
<a name="l00740"></a>00740         <span class="keywordflow">if</span>($this-&gt;connected === <span class="keyword">false</span>){
<a name="l00741"></a>00741             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00742"></a>00742         }
<a name="l00743"></a>00743         $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev = <span class="keyword">new</span> DataPacketSendEvent($this, $packet));
<a name="l00744"></a>00744         <span class="keywordflow">if</span>($ev-&gt;isCancelled()){
<a name="l00745"></a>00745             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00746"></a>00746         }
<a name="l00747"></a>00747 
<a name="l00748"></a>00748         $identifier = $this-&gt;interface-&gt;putPacket($this, $packet, $needACK, <span class="keyword">true</span>);
<a name="l00749"></a>00749 
<a name="l00750"></a>00750         <span class="keywordflow">if</span>($needACK and $identifier !== null){
<a name="l00751"></a>00751             $this-&gt;needACK[$identifier] = <span class="keyword">false</span>;
<a name="l00752"></a>00752 
<a name="l00753"></a>00753             <span class="keywordflow">return</span> $identifier;
<a name="l00754"></a>00754         }
<a name="l00755"></a>00755 
<a name="l00756"></a>00756         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00757"></a>00757     }
<a name="l00758"></a>00758 
<a name="l00764"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a0387ebe51fad82fe51280e1dbb59b619">00764</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a0387ebe51fad82fe51280e1dbb59b619">sleepOn</a>(Vector3 $pos){
<a name="l00765"></a>00765         <span class="keywordflow">foreach</span>($this-&gt;getLevel()-&gt;getPlayers() as $p){
<a name="l00766"></a>00766             <span class="keywordflow">if</span>($p-&gt;sleeping instanceof Vector3){
<a name="l00767"></a>00767                 <span class="keywordflow">if</span>($pos-&gt;distance($p-&gt;sleeping) &lt;= 0.1){
<a name="l00768"></a>00768                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00769"></a>00769                 }
<a name="l00770"></a>00770             }
<a name="l00771"></a>00771         }
<a name="l00772"></a>00772         $this-&gt;sleeping = $pos;
<a name="l00773"></a>00773         $this-&gt;teleport(<span class="keyword">new</span> Position($pos-&gt;x + 0.5, $pos-&gt;y + 1, $pos-&gt;z + 0.5, $this-&gt;getLevel()));
<a name="l00774"></a>00774         <span class="comment">/*if($this-&gt;entity instanceof Entity){</span>
<a name="l00775"></a>00775 <span class="comment">            $this-&gt;updateMetadata();</span>
<a name="l00776"></a>00776 <span class="comment">        }*/</span>
<a name="l00777"></a>00777         $this-&gt;setSpawn($pos);
<a name="l00778"></a>00778         $this-&gt;server-&gt;getScheduler()-&gt;scheduleDelayedTask(<span class="keyword">new</span> CallbackTask(array($this, <span class="stringliteral">&quot;checkSleep&quot;</span>)), 60);
<a name="l00779"></a>00779 
<a name="l00780"></a>00780         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00781"></a>00781     }
<a name="l00782"></a>00782 
<a name="l00788"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a08cec60d840f5f3569d80edf7b4803c8">00788</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a08cec60d840f5f3569d80edf7b4803c8">setSpawn</a>(Vector3 $pos){
<a name="l00789"></a>00789         <span class="keywordflow">if</span>(!($pos instanceof Position)){
<a name="l00790"></a>00790             $level = $this-&gt;getLevel();
<a name="l00791"></a>00791         }<span class="keywordflow">else</span>{
<a name="l00792"></a>00792             $level = $pos-&gt;getLevel();
<a name="l00793"></a>00793         }
<a name="l00794"></a>00794         $this-&gt;spawnPosition = <span class="keyword">new</span> Position($pos-&gt;x, $pos-&gt;y, $pos-&gt;z, $level);
<a name="l00795"></a>00795         $pk = <span class="keyword">new</span> SetSpawnPositionPacket;
<a name="l00796"></a>00796         $pk-&gt;x = (int) $this-&gt;spawnPosition-&gt;x;
<a name="l00797"></a>00797         $pk-&gt;y = (<span class="keywordtype">int</span>) $this-&gt;spawnPosition-&gt;y;
<a name="l00798"></a>00798         $pk-&gt;z = (int) $this-&gt;spawnPosition-&gt;z;
<a name="l00799"></a>00799         $this-&gt;dataPacket($pk);
<a name="l00800"></a>00800     }
<a name="l00801"></a>00801 
<a name="l00802"></a>00802     <span class="keyword">public</span> <span class="keyword">function</span> stopSleep(){
<a name="l00803"></a>00803         $this-&gt;sleeping = <span class="keyword">false</span>;
<a name="l00804"></a>00804         <span class="comment">//if($this-&gt;entity instanceof Entity){</span>
<a name="l00805"></a>00805         <span class="comment">//$this-&gt;entity-&gt;updateMetadata();</span>
<a name="l00806"></a>00806         <span class="comment">//}</span>
<a name="l00807"></a>00807     }
<a name="l00808"></a>00808 
<a name="l00813"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a549101e23d7654e52f7af8ff07c64e46">00813</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a549101e23d7654e52f7af8ff07c64e46">checkSleep</a>(){
<a name="l00814"></a>00814         <span class="keywordflow">if</span>($this-&gt;sleeping !== <span class="keyword">false</span>){
<a name="l00815"></a>00815             <span class="comment">//TODO: Move to Level</span>
<a name="l00816"></a>00816             <span class="comment">/*if($this-&gt;server-&gt;api-&gt;time-&gt;getPhase($this-&gt;getLevel()) === &quot;night&quot;){</span>
<a name="l00817"></a>00817 <span class="comment">                foreach($this-&gt;getLevel()-&gt;getPlayers() as $p){</span>
<a name="l00818"></a>00818 <span class="comment">                    if($p-&gt;sleeping === false){</span>
<a name="l00819"></a>00819 <span class="comment">                        return;</span>
<a name="l00820"></a>00820 <span class="comment">                    }</span>
<a name="l00821"></a>00821 <span class="comment">                }</span>
<a name="l00822"></a>00822 <span class="comment">                $this-&gt;server-&gt;api-&gt;time-&gt;set(&quot;day&quot;, $this-&gt;getLevel());</span>
<a name="l00823"></a>00823 <span class="comment">                foreach($this-&gt;getLevel()-&gt;getPlayers() as $p){</span>
<a name="l00824"></a>00824 <span class="comment">                    $p-&gt;stopSleep();</span>
<a name="l00825"></a>00825 <span class="comment">                }</span>
<a name="l00826"></a>00826 <span class="comment">            }*/</span>
<a name="l00827"></a>00827         }
<a name="l00828"></a>00828 
<a name="l00829"></a>00829         <span class="keywordflow">return</span>;
<a name="l00830"></a>00830     }
<a name="l00831"></a>00831 
<a name="l00832"></a>00832     <span class="comment">/*public function eventHandler($data, $event){</span>
<a name="l00833"></a>00833 <span class="comment">        switch($event){</span>
<a name="l00834"></a>00834 <span class="comment">            //TODO, obsolete</span>
<a name="l00835"></a>00835 <span class="comment">            case &quot;tile.update&quot;:</span>
<a name="l00836"></a>00836 <span class="comment">                if($data-&gt;getLevel() === $this-&gt;getLevel()){</span>
<a name="l00837"></a>00837 <span class="comment">                    if($data instanceof Furnace){</span>
<a name="l00838"></a>00838 <span class="comment">                        foreach($this-&gt;windows as $id =&gt; $w){</span>
<a name="l00839"></a>00839 <span class="comment">                            if($w === $data){</span>
<a name="l00840"></a>00840 <span class="comment">                                $pk = new ContainerSetDataPacket;</span>
<a name="l00841"></a>00841 <span class="comment">                                $pk-&gt;windowid = $id;</span>
<a name="l00842"></a>00842 <span class="comment">                                $pk-&gt;property = 0; //Smelting</span>
<a name="l00843"></a>00843 <span class="comment">                                $pk-&gt;value = floor($data-&gt;namedtag-&gt;CookTime);</span>
<a name="l00844"></a>00844 <span class="comment">                                $this-&gt;dataPacket($pk);</span>
<a name="l00845"></a>00845 <span class="comment"></span>
<a name="l00846"></a>00846 <span class="comment">                                $pk = new ContainerSetDataPacket;</span>
<a name="l00847"></a>00847 <span class="comment">                                $pk-&gt;windowid = $id;</span>
<a name="l00848"></a>00848 <span class="comment">                                $pk-&gt;property = 1; //Fire icon</span>
<a name="l00849"></a>00849 <span class="comment">                                $pk-&gt;value = $data-&gt;namedtag-&gt;BurnTicks;</span>
<a name="l00850"></a>00850 <span class="comment">                                $this-&gt;dataPacket($pk);</span>
<a name="l00851"></a>00851 <span class="comment">                            }</span>
<a name="l00852"></a>00852 <span class="comment">                        }</span>
<a name="l00853"></a>00853 <span class="comment">                    }</span>
<a name="l00854"></a>00854 <span class="comment">                }</span>
<a name="l00855"></a>00855 <span class="comment">                break;</span>
<a name="l00856"></a>00856 <span class="comment">            case &quot;entity.metadata&quot;:</span>
<a name="l00857"></a>00857 <span class="comment">                if($data-&gt;getID() === $this-&gt;id){</span>
<a name="l00858"></a>00858 <span class="comment">                    $eid = 0;</span>
<a name="l00859"></a>00859 <span class="comment">                }else{</span>
<a name="l00860"></a>00860 <span class="comment">                    $eid = $data-&gt;getID();</span>
<a name="l00861"></a>00861 <span class="comment">                }</span>
<a name="l00862"></a>00862 <span class="comment">                if($data-&gt;getLevel() === $this-&gt;getLevel()){</span>
<a name="l00863"></a>00863 <span class="comment">                    $pk = new SetEntityDataPacket;</span>
<a name="l00864"></a>00864 <span class="comment">                    $pk-&gt;eid = $eid;</span>
<a name="l00865"></a>00865 <span class="comment">                    $pk-&gt;metadata = $data-&gt;getDamage();</span>
<a name="l00866"></a>00866 <span class="comment">                    $this-&gt;dataPacket($pk);</span>
<a name="l00867"></a>00867 <span class="comment">                }</span>
<a name="l00868"></a>00868 <span class="comment">                break;</span>
<a name="l00869"></a>00869 <span class="comment">        }</span>
<a name="l00870"></a>00870 <span class="comment">    }*/</span>
<a name="l00871"></a>00871 
<a name="l00877"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ada5f649ef3f1fa2b64b92c12f3f49291">00877</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ada5f649ef3f1fa2b64b92c12f3f49291">awardAchievement</a>($achievementId){
<a name="l00878"></a>00878         <span class="keywordflow">if</span>(isset(Achievement::$list[$achievementId]) and !$this-&gt;hasAchievement($achievementId)){
<a name="l00879"></a>00879             <span class="keywordflow">foreach</span>(Achievement::$list[$achievementId][<span class="stringliteral">&quot;requires&quot;</span>] as $requerimentId){
<a name="l00880"></a>00880                 <span class="keywordflow">if</span>(!$this-&gt;hasAchievement($requerimentId)){
<a name="l00881"></a>00881                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00882"></a>00882                 }
<a name="l00883"></a>00883             }
<a name="l00884"></a>00884             $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev = <span class="keyword">new</span> PlayerAchievementAwardedEvent($this, $achievementId));
<a name="l00885"></a>00885             <span class="keywordflow">if</span>(!$ev-&gt;isCancelled()){
<a name="l00886"></a>00886                 $this-&gt;achievements[$achievementId] = <span class="keyword">true</span>;
<a name="l00887"></a>00887                 Achievement::broadcast($this, $achievementId);
<a name="l00888"></a>00888 
<a name="l00889"></a>00889                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00890"></a>00890             }<span class="keywordflow">else</span>{
<a name="l00891"></a>00891                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00892"></a>00892             }
<a name="l00893"></a>00893         }
<a name="l00894"></a>00894 
<a name="l00895"></a>00895         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00896"></a>00896     }
<a name="l00897"></a>00897 
<a name="l00901"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ac024accbfc779b0ba0110b8e32216db5">00901</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ac024accbfc779b0ba0110b8e32216db5">getGamemode</a>(){
<a name="l00902"></a>00902         <span class="keywordflow">return</span> $this-&gt;gamemode;
<a name="l00903"></a>00903     }
<a name="l00904"></a>00904 
<a name="l00913"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a3cae4586fee124e392956f753e7d4e52">00913</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a3cae4586fee124e392956f753e7d4e52">setGamemode</a>($gm){
<a name="l00914"></a>00914         <span class="keywordflow">if</span>($gm &lt; 0 or $gm &gt; 3 or $this-&gt;gamemode === $gm){
<a name="l00915"></a>00915             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00916"></a>00916         }
<a name="l00917"></a>00917 
<a name="l00918"></a>00918         $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev = <span class="keyword">new</span> PlayerGameModeChangeEvent($this, (<span class="keywordtype">int</span>) $gm));
<a name="l00919"></a>00919         <span class="keywordflow">if</span>($ev-&gt;isCancelled()){
<a name="l00920"></a>00920             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00921"></a>00921         }
<a name="l00922"></a>00922 
<a name="l00923"></a>00923         <span class="keywordflow">if</span>(($this-&gt;gamemode &amp; 0x01) === ($gm &amp; 0x01)){
<a name="l00924"></a>00924             $this-&gt;gamemode = $gm;
<a name="l00925"></a>00925             $this-&gt;sendMessage(<span class="stringliteral">&quot;Your gamemode has been changed to &quot;</span> . Server::getGamemodeString($this-&gt;getGamemode()) . <span class="stringliteral">&quot;.\n&quot;</span>);
<a name="l00926"></a>00926         }<span class="keywordflow">else</span>{
<a name="l00927"></a>00927             $this-&gt;gamemode = $gm;
<a name="l00928"></a>00928             $this-&gt;sendMessage(<span class="stringliteral">&quot;Your gamemode has been changed to &quot;</span> . Server::getGamemodeString($this-&gt;getGamemode()) . <span class="stringliteral">&quot;.\n&quot;</span>);
<a name="l00929"></a>00929             $this-&gt;inventory-&gt;clearAll();
<a name="l00930"></a>00930             $this-&gt;inventory-&gt;sendContents($this-&gt;getViewers());
<a name="l00931"></a>00931             $this-&gt;inventory-&gt;sendHeldItem($this-&gt;hasSpawned);
<a name="l00932"></a>00932         }
<a name="l00933"></a>00933 
<a name="l00934"></a>00934         $this-&gt;namedtag-&gt;playerGameType = <span class="keyword">new</span> Int(<span class="stringliteral">&quot;playerGameType&quot;</span>, $this-&gt;gamemode);
<a name="l00935"></a>00935 
<a name="l00936"></a>00936         $pk = <span class="keyword">new</span> StartGamePacket;
<a name="l00937"></a>00937         $pk-&gt;seed = $this-&gt;getLevel()-&gt;getSeed();
<a name="l00938"></a>00938         $pk-&gt;x = $this-&gt;x;
<a name="l00939"></a>00939         $pk-&gt;y = $this-&gt;y;
<a name="l00940"></a>00940         $pk-&gt;z = $this-&gt;z;
<a name="l00941"></a>00941         $pk-&gt;spawnX = (int) $this-&gt;spawnPosition-&gt;x;
<a name="l00942"></a>00942         $pk-&gt;spawnY = (<span class="keywordtype">int</span>) $this-&gt;spawnPosition-&gt;y;
<a name="l00943"></a>00943         $pk-&gt;spawnZ = (int) $this-&gt;spawnPosition-&gt;z;
<a name="l00944"></a>00944         $pk-&gt;generator = 1; <span class="comment">//0 old, 1 infinite, 2 flat</span>
<a name="l00945"></a>00945         $pk-&gt;gamemode = $this-&gt;gamemode &amp; 0x01;
<a name="l00946"></a>00946         $pk-&gt;eid = 0; <span class="comment">//Always use EntityID as zero for the actual player</span>
<a name="l00947"></a>00947         $this-&gt;dataPacket($pk);
<a name="l00948"></a>00948         $this-&gt;sendSettings();
<a name="l00949"></a>00949 
<a name="l00950"></a>00950         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00951"></a>00951     }
<a name="l00952"></a>00952 
<a name="l00961"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#acddc8b7ce9c3b80d0aeed314db8a3445">00961</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#acddc8b7ce9c3b80d0aeed314db8a3445">sendSettings</a>($nametags = <span class="keyword">true</span>){
<a name="l00962"></a>00962         <span class="comment">/*</span>
<a name="l00963"></a>00963 <span class="comment">         bit mask | flag name</span>
<a name="l00964"></a>00964 <span class="comment">        0x00000001 world_inmutable</span>
<a name="l00965"></a>00965 <span class="comment">        0x00000002 -</span>
<a name="l00966"></a>00966 <span class="comment">        0x00000004 -</span>
<a name="l00967"></a>00967 <span class="comment">        0x00000008 - (autojump)</span>
<a name="l00968"></a>00968 <span class="comment">        0x00000010 -</span>
<a name="l00969"></a>00969 <span class="comment">        0x00000020 nametags_visible</span>
<a name="l00970"></a>00970 <span class="comment">        0x00000040 ?</span>
<a name="l00971"></a>00971 <span class="comment">        0x00000080 ?</span>
<a name="l00972"></a>00972 <span class="comment">        0x00000100 ?</span>
<a name="l00973"></a>00973 <span class="comment">        0x00000200 ?</span>
<a name="l00974"></a>00974 <span class="comment">        0x00000400 ?</span>
<a name="l00975"></a>00975 <span class="comment">        0x00000800 ?</span>
<a name="l00976"></a>00976 <span class="comment">        0x00001000 ?</span>
<a name="l00977"></a>00977 <span class="comment">        0x00002000 ?</span>
<a name="l00978"></a>00978 <span class="comment">        0x00004000 ?</span>
<a name="l00979"></a>00979 <span class="comment">        0x00008000 ?</span>
<a name="l00980"></a>00980 <span class="comment">        0x00010000 ?</span>
<a name="l00981"></a>00981 <span class="comment">        0x00020000 ?</span>
<a name="l00982"></a>00982 <span class="comment">        0x00040000 ?</span>
<a name="l00983"></a>00983 <span class="comment">        0x00080000 ?</span>
<a name="l00984"></a>00984 <span class="comment">        0x00100000 ?</span>
<a name="l00985"></a>00985 <span class="comment">        0x00200000 ?</span>
<a name="l00986"></a>00986 <span class="comment">        0x00400000 ?</span>
<a name="l00987"></a>00987 <span class="comment">        0x00800000 ?</span>
<a name="l00988"></a>00988 <span class="comment">        0x01000000 ?</span>
<a name="l00989"></a>00989 <span class="comment">        0x02000000 ?</span>
<a name="l00990"></a>00990 <span class="comment">        0x04000000 ?</span>
<a name="l00991"></a>00991 <span class="comment">        0x08000000 ?</span>
<a name="l00992"></a>00992 <span class="comment">        0x10000000 ?</span>
<a name="l00993"></a>00993 <span class="comment">        0x20000000 ?</span>
<a name="l00994"></a>00994 <span class="comment">        0x40000000 ?</span>
<a name="l00995"></a>00995 <span class="comment">        0x80000000 ?</span>
<a name="l00996"></a>00996 <span class="comment">        */</span>
<a name="l00997"></a>00997         $flags = 0;
<a name="l00998"></a>00998         <span class="keywordflow">if</span>(($this-&gt;gamemode &amp; 0x02) === 0x02){
<a name="l00999"></a>00999             $flags |= 0x01; <span class="comment">//Do not allow placing/breaking blocks, adventure mode</span>
<a name="l01000"></a>01000         }
<a name="l01001"></a>01001 
<a name="l01002"></a>01002         <span class="keywordflow">if</span>($nametags !== <span class="keyword">false</span>){
<a name="l01003"></a>01003             $flags |= 0x20; <span class="comment">//Show Nametags</span>
<a name="l01004"></a>01004         }
<a name="l01005"></a>01005 
<a name="l01006"></a>01006         $pk = <span class="keyword">new</span> AdventureSettingsPacket;
<a name="l01007"></a>01007         $pk-&gt;flags = $flags;
<a name="l01008"></a>01008         $this-&gt;dataPacket($pk);
<a name="l01009"></a>01009     }
<a name="l01010"></a>01010 
<a name="l01011"></a>01011     <span class="keyword">protected</span> <span class="keyword">function</span> getCreativeBlock(Item $item){
<a name="l01012"></a>01012         <span class="keywordflow">foreach</span>(Block::$creative as $i =&gt; $d){
<a name="l01013"></a>01013             <span class="keywordflow">if</span>($d[0] === $item-&gt;getID() and $d[1] === $item-&gt;getDamage()){
<a name="l01014"></a>01014                 <span class="keywordflow">return</span> $i;
<a name="l01015"></a>01015             }
<a name="l01016"></a>01016         }
<a name="l01017"></a>01017 
<a name="l01018"></a>01018         <span class="keywordflow">return</span> -1;
<a name="l01019"></a>01019     }
<a name="l01020"></a>01020 
<a name="l01021"></a>01021     <span class="keyword">public</span> <span class="keyword">function</span> onUpdate(){
<a name="l01022"></a>01022         <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">false</span>){
<a name="l01023"></a>01023             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01024"></a>01024         }
<a name="l01025"></a>01025         $hasUpdate = $this-&gt;entityBaseTick();
<a name="l01026"></a>01026         <span class="keywordflow">foreach</span>($this-&gt;getLevel()-&gt;getNearbyEntities($this-&gt;boundingBox-&gt;expand(1, 1, 1), $this) as $entity){
<a name="l01027"></a>01027             <span class="keywordflow">if</span>($entity instanceof DroppedItem){
<a name="l01028"></a>01028                 <span class="keywordflow">if</span>($entity-&gt;dead !== <span class="keyword">true</span> and $entity-&gt;getPickupDelay() &lt;= 0){
<a name="l01029"></a>01029                     $item = $entity-&gt;getItem();
<a name="l01030"></a>01030 
<a name="l01031"></a>01031                     <span class="keywordflow">if</span>($item instanceof Item){
<a name="l01032"></a>01032                         <span class="keywordflow">if</span>(($this-&gt;gamemode &amp; 0x01) === 0 and !$this-&gt;inventory-&gt;canAddItem($item)){
<a name="l01033"></a>01033                             <span class="keywordflow">continue</span>;
<a name="l01034"></a>01034                         }
<a name="l01035"></a>01035 
<a name="l01036"></a>01036                         $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev = <span class="keyword">new</span> InventoryPickupItemEvent($this-&gt;inventory, $item));
<a name="l01037"></a>01037                         <span class="keywordflow">if</span>($ev-&gt;isCancelled()){
<a name="l01038"></a>01038                             <span class="keywordflow">continue</span>;
<a name="l01039"></a>01039                         }
<a name="l01040"></a>01040 
<a name="l01041"></a>01041                         <span class="keywordflow">switch</span>($item-&gt;getID()){
<a name="l01042"></a>01042                             <span class="keywordflow">case</span> Item::WOOD:
<a name="l01043"></a>01043                                 $this-&gt;awardAchievement(<span class="stringliteral">&quot;mineWood&quot;</span>);
<a name="l01044"></a>01044                                 <span class="keywordflow">break</span>;
<a name="l01045"></a>01045                             <span class="keywordflow">case</span> Item::DIAMOND:
<a name="l01046"></a>01046                                 $this-&gt;awardAchievement(<span class="stringliteral">&quot;diamond&quot;</span>);
<a name="l01047"></a>01047                                 <span class="keywordflow">break</span>;
<a name="l01048"></a>01048                         }
<a name="l01049"></a>01049 
<a name="l01050"></a>01050                         $pk = <span class="keyword">new</span> TakeItemEntityPacket;
<a name="l01051"></a>01051                         $pk-&gt;eid = 0;
<a name="l01052"></a>01052                         $pk-&gt;target = $entity-&gt;getID();
<a name="l01053"></a>01053                         $this-&gt;dataPacket($pk);
<a name="l01054"></a>01054 
<a name="l01055"></a>01055                         $pk = <span class="keyword">new</span> TakeItemEntityPacket;
<a name="l01056"></a>01056                         $pk-&gt;eid = $this-&gt;getID();
<a name="l01057"></a>01057                         $pk-&gt;target = $entity-&gt;getID();
<a name="l01058"></a>01058                         $this-&gt;server-&gt;broadcastPacket($entity-&gt;getViewers(), $pk);
<a name="l01059"></a>01059                         $this-&gt;inventory-&gt;addItem(clone $item);
<a name="l01060"></a>01060                         $entity-&gt;kill();
<a name="l01061"></a>01061                     }
<a name="l01062"></a>01062                 }
<a name="l01063"></a>01063             }
<a name="l01064"></a>01064         }
<a name="l01065"></a>01065     }
<a name="l01066"></a>01066 
<a name="l01076"></a>01076     <span class="keyword">public</span> <span class="keyword">function</span> handleDataPacket(DataPacket $packet){
<a name="l01077"></a>01077         <span class="keywordflow">if</span>($this-&gt;connected === <span class="keyword">false</span>){
<a name="l01078"></a>01078             <span class="keywordflow">return</span>;
<a name="l01079"></a>01079         }
<a name="l01080"></a>01080 
<a name="l01081"></a>01081         $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev = <span class="keyword">new</span> DataPacketReceiveEvent($this, $packet));
<a name="l01082"></a>01082         <span class="keywordflow">if</span>($ev-&gt;isCancelled()){
<a name="l01083"></a>01083             <span class="keywordflow">return</span>;
<a name="l01084"></a>01084         }
<a name="l01085"></a>01085 
<a name="l01086"></a>01086         <span class="keywordflow">switch</span>($packet-&gt;pid()){
<a name="l01087"></a>01087             <span class="keywordflow">case</span> ProtocolInfo::LOGIN_PACKET:
<a name="l01088"></a>01088                 <span class="keywordflow">if</span>($this-&gt;loggedIn === <span class="keyword">true</span>){
<a name="l01089"></a>01089                     <span class="keywordflow">break</span>;
<a name="l01090"></a>01090                 }
<a name="l01091"></a>01091 
<a name="l01092"></a>01092                 $this-&gt;username = TextFormat::clean($packet-&gt;username);
<a name="l01093"></a>01093                 $this-&gt;displayName = $this-&gt;username;
<a name="l01094"></a>01094                 $this-&gt;nameTag = $this-&gt;username;
<a name="l01095"></a>01095                 $this-&gt;iusername = strtolower($this-&gt;username);
<a name="l01096"></a>01096                 $this-&gt;loginData = array(<span class="stringliteral">&quot;clientId&quot;</span> =&gt; $packet-&gt;clientId, <span class="stringliteral">&quot;loginData&quot;</span> =&gt; $packet-&gt;loginData);
<a name="l01097"></a>01097 
<a name="l01098"></a>01098                 <span class="keywordflow">if</span>(count($this-&gt;server-&gt;getOnlinePlayers()) &gt; $this-&gt;server-&gt;getMaxPlayers()){
<a name="l01099"></a>01099                     <span class="keywordflow">if</span>($this-&gt;kick(<span class="stringliteral">&quot;server full&quot;</span>) === <span class="keyword">true</span>){
<a name="l01100"></a>01100                         <span class="keywordflow">return</span>;
<a name="l01101"></a>01101                     }
<a name="l01102"></a>01102                 }
<a name="l01103"></a>01103                 <span class="keywordflow">if</span>($packet-&gt;protocol1 !== ProtocolInfo::CURRENT_PROTOCOL){
<a name="l01104"></a>01104                     <span class="keywordflow">if</span>($packet-&gt;protocol1 &lt; ProtocolInfo::CURRENT_PROTOCOL){
<a name="l01105"></a>01105                         $pk = <span class="keyword">new</span> LoginStatusPacket;
<a name="l01106"></a>01106                         $pk-&gt;status = 1;
<a name="l01107"></a>01107                         $this-&gt;dataPacket($pk);
<a name="l01108"></a>01108                     }<span class="keywordflow">else</span>{
<a name="l01109"></a>01109                         $pk = <span class="keyword">new</span> LoginStatusPacket;
<a name="l01110"></a>01110                         $pk-&gt;status = 2;
<a name="l01111"></a>01111                         $this-&gt;dataPacket($pk);
<a name="l01112"></a>01112                     }
<a name="l01113"></a>01113                     $this-&gt;close(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;Incorrect protocol #&quot;</span> . $packet-&gt;protocol1, <span class="keyword">false</span>);
<a name="l01114"></a>01114 
<a name="l01115"></a>01115                     <span class="keywordflow">return</span>;
<a name="l01116"></a>01116                 }
<a name="l01117"></a>01117                 <span class="keywordflow">if</span>(preg_match(<span class="stringliteral">&#39;#^[a-zA-Z0-9_]{3,16}$#&#39;</span>, $packet-&gt;username) == 0 or $this-&gt;username === <span class="stringliteral">&quot;&quot;</span> or $this-&gt;iusername === <span class="stringliteral">&quot;rcon&quot;</span> or $this-&gt;iusername === <span class="stringliteral">&quot;console&quot;</span> or strlen($packet-&gt;username) &gt; 16 or strlen($packet-&gt;username) &lt; 3){
<a name="l01118"></a>01118                     $this-&gt;close(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;Bad username&quot;</span>);
<a name="l01119"></a>01119 
<a name="l01120"></a>01120                     <span class="keywordflow">return</span>;
<a name="l01121"></a>01121                 }
<a name="l01122"></a>01122 
<a name="l01123"></a>01123                 $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev = <span class="keyword">new</span> PlayerPreLoginEvent($this, <span class="stringliteral">&quot;Plugin reason&quot;</span>));
<a name="l01124"></a>01124                 <span class="keywordflow">if</span>($ev-&gt;isCancelled()){
<a name="l01125"></a>01125                     $this-&gt;close(<span class="stringliteral">&quot;&quot;</span>, $ev-&gt;getKickMessage());
<a name="l01126"></a>01126 
<a name="l01127"></a>01127                     <span class="keywordflow">return</span>;
<a name="l01128"></a>01128                 }
<a name="l01129"></a>01129 
<a name="l01130"></a>01130                 <span class="keywordflow">if</span>(!$this-&gt;server-&gt;isWhitelisted(strtolower($this-&gt;getName()))){
<a name="l01131"></a>01131                     $this-&gt;close(TextFormat::YELLOW . $this-&gt;username . <span class="stringliteral">&quot; has left the game&quot;</span>, <span class="stringliteral">&quot;Server is white-listed&quot;</span>);
<a name="l01132"></a>01132 
<a name="l01133"></a>01133                     <span class="keywordflow">return</span>;
<a name="l01134"></a>01134                 }elseif($this-&gt;server-&gt;getNameBans()-&gt;isBanned(strtolower($this-&gt;getName())) or $this-&gt;server-&gt;getIPBans()-&gt;isBanned($this-&gt;getAddress())){
<a name="l01135"></a>01135                     $this-&gt;close(TextFormat::YELLOW . $this-&gt;username . <span class="stringliteral">&quot; has left the game&quot;</span>, <span class="stringliteral">&quot;You are banned&quot;</span>);
<a name="l01136"></a>01136 
<a name="l01137"></a>01137                     <span class="keywordflow">return</span>;
<a name="l01138"></a>01138                 }
<a name="l01139"></a>01139 
<a name="l01140"></a>01140                 <span class="keywordflow">if</span>($this-&gt;hasPermission(Server::BROADCAST_CHANNEL_USERS)){
<a name="l01141"></a>01141                     $this-&gt;server-&gt;getPluginManager()-&gt;subscribeToPermission(Server::BROADCAST_CHANNEL_USERS, $this);
<a name="l01142"></a>01142                 }
<a name="l01143"></a>01143                 <span class="keywordflow">if</span>($this-&gt;hasPermission(Server::BROADCAST_CHANNEL_ADMINISTRATIVE)){
<a name="l01144"></a>01144                     $this-&gt;server-&gt;getPluginManager()-&gt;subscribeToPermission(Server::BROADCAST_CHANNEL_ADMINISTRATIVE, $this);
<a name="l01145"></a>01145                 }
<a name="l01146"></a>01146 
<a name="l01147"></a>01147                 <span class="keywordflow">foreach</span>($this-&gt;server-&gt;getOnlinePlayers() as $p){
<a name="l01148"></a>01148                     <span class="keywordflow">if</span>($p !== $this and strtolower($p-&gt;getName()) === strtolower($this-&gt;getName())){
<a name="l01149"></a>01149                         <span class="keywordflow">if</span>($p-&gt;kick(<span class="stringliteral">&quot;logged in from another location&quot;</span>) === <span class="keyword">false</span>){
<a name="l01150"></a>01150                             $this-&gt;close(TextFormat::YELLOW . $this-&gt;getName() . <span class="stringliteral">&quot; has left the game&quot;</span>, <span class="stringliteral">&quot;Logged in from another location&quot;</span>);
<a name="l01151"></a>01151 
<a name="l01152"></a>01152                             <span class="keywordflow">return</span>;
<a name="l01153"></a>01153                         }<span class="keywordflow">else</span>{
<a name="l01154"></a>01154                             <span class="keywordflow">break</span>;
<a name="l01155"></a>01155                         }
<a name="l01156"></a>01156                     }
<a name="l01157"></a>01157                 }
<a name="l01158"></a>01158 
<a name="l01159"></a>01159                 $nbt = $this-&gt;server-&gt;getOfflinePlayerData($this-&gt;username);
<a name="l01160"></a>01160                 <span class="keywordflow">if</span>(!isset($nbt-&gt;NameTag)){
<a name="l01161"></a>01161                     $nbt-&gt;NameTag = <span class="keyword">new</span> String(<span class="stringliteral">&quot;NameTag&quot;</span>, $this-&gt;username);
<a name="l01162"></a>01162                 }<span class="keywordflow">else</span>{
<a name="l01163"></a>01163                     $nbt[<span class="stringliteral">&quot;NameTag&quot;</span>] = $this-&gt;username;
<a name="l01164"></a>01164                 }
<a name="l01165"></a>01165                 $this-&gt;gamemode = $nbt[<span class="stringliteral">&quot;playerGameType&quot;</span>] &amp; 0x03;
<a name="l01166"></a>01166                 <span class="keywordflow">if</span>($this-&gt;server-&gt;getForceGamemode()){
<a name="l01167"></a>01167                     $this-&gt;gamemode = $this-&gt;server-&gt;getGamemode();
<a name="l01168"></a>01168                     $nbt-&gt;playerGameType = <span class="keyword">new</span> Int(<span class="stringliteral">&quot;playerGameType&quot;</span>, $this-&gt;gamemode);
<a name="l01169"></a>01169                 }
<a name="l01170"></a>01170                 <span class="keywordflow">if</span>(($level = $this-&gt;server-&gt;getLevelByName($nbt[<span class="stringliteral">&quot;Level&quot;</span>])) === null){
<a name="l01171"></a>01171                     $this-&gt;setLevel($this-&gt;server-&gt;getDefaultLevel(), <span class="keyword">true</span>);
<a name="l01172"></a>01172                     $nbt[<span class="stringliteral">&quot;Level&quot;</span>] = $this-&gt;getLevel()-&gt;getName();
<a name="l01173"></a>01173                     $nbt[<span class="stringliteral">&quot;Pos&quot;</span>][0] = $this-&gt;getLevel()-&gt;getSpawn()-&gt;x;
<a name="l01174"></a>01174                     $nbt[<span class="stringliteral">&quot;Pos&quot;</span>][1] = $this-&gt;getLevel()-&gt;getSpawn()-&gt;y;
<a name="l01175"></a>01175                     $nbt[<span class="stringliteral">&quot;Pos&quot;</span>][2] = $this-&gt;getLevel()-&gt;getSpawn()-&gt;z;
<a name="l01176"></a>01176                 }<span class="keywordflow">else</span>{
<a name="l01177"></a>01177                     $this-&gt;setLevel($level, <span class="keyword">true</span>);
<a name="l01178"></a>01178                 }
<a name="l01179"></a>01179 
<a name="l01180"></a>01180                 <span class="keywordflow">if</span>(!($nbt instanceof Compound)){
<a name="l01181"></a>01181                     $this-&gt;close(TextFormat::YELLOW . $this-&gt;username . <span class="stringliteral">&quot; has left the game&quot;</span>, <span class="stringliteral">&quot;Invalid data&quot;</span>);
<a name="l01182"></a>01182 
<a name="l01183"></a>01183                     <span class="keywordflow">return</span>;
<a name="l01184"></a>01184                 }
<a name="l01185"></a>01185 
<a name="l01186"></a>01186                 $this-&gt;achievements = [];
<a name="l01187"></a>01187 
<a name="l01189"></a>01189                 <span class="keywordflow">foreach</span>($nbt-&gt;Achievements as $achievement){
<a name="l01190"></a>01190                     $this-&gt;achievements[$achievement-&gt;getName()] = $achievement-&gt;getValue() &gt; 0 ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01191"></a>01191                 }
<a name="l01192"></a>01192 
<a name="l01193"></a>01193                 $nbt[<span class="stringliteral">&quot;lastPlayed&quot;</span>] = floor(microtime(<span class="keyword">true</span>) * 1000);
<a name="l01194"></a>01194                 $this-&gt;server-&gt;saveOfflinePlayerData($this-&gt;username, $nbt);
<a name="l01195"></a>01195                 parent::__construct($this-&gt;getLevel()-&gt;getChunkAt($nbt[<span class="stringliteral">&quot;Pos&quot;</span>][0], $nbt[<span class="stringliteral">&quot;Pos&quot;</span>][2], <span class="keyword">true</span>), $nbt);
<a name="l01196"></a>01196                 $this-&gt;loggedIn = <span class="keyword">true</span>;
<a name="l01197"></a>01197 
<a name="l01198"></a>01198                 $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev = <span class="keyword">new</span> PlayerLoginEvent($this, <span class="stringliteral">&quot;Plugin reason&quot;</span>));
<a name="l01199"></a>01199                 <span class="keywordflow">if</span>($ev-&gt;isCancelled()){
<a name="l01200"></a>01200                     $this-&gt;close(TextFormat::YELLOW . $this-&gt;username . <span class="stringliteral">&quot; has left the game&quot;</span>, $ev-&gt;getKickMessage());
<a name="l01201"></a>01201 
<a name="l01202"></a>01202                     <span class="keywordflow">return</span>;
<a name="l01203"></a>01203                 }
<a name="l01204"></a>01204 
<a name="l01205"></a>01205                 <span class="keywordflow">if</span>(($this-&gt;gamemode &amp; 0x01) === 0x01){
<a name="l01206"></a>01206                     $this-&gt;inventory-&gt;setHeldItemSlot(0);
<a name="l01207"></a>01207                     $this-&gt;inventory-&gt;setItemInHand(Item::get(Item::STONE, 0, 1));
<a name="l01208"></a>01208                 }
<a name="l01209"></a>01209 
<a name="l01210"></a>01210                 $pk = <span class="keyword">new</span> LoginStatusPacket;
<a name="l01211"></a>01211                 $pk-&gt;status = 0;
<a name="l01212"></a>01212                 $this-&gt;directDataPacket($pk);
<a name="l01213"></a>01213 
<a name="l01214"></a>01214                 <span class="keywordflow">if</span>(($level = $this-&gt;server-&gt;getLevelByName($this-&gt;namedtag[<span class="stringliteral">&quot;SpawnLevel&quot;</span>])) instanceof Level){
<a name="l01215"></a>01215                     $this-&gt;spawnPosition = <span class="keyword">new</span> Position($this-&gt;namedtag[<span class="stringliteral">&quot;SpawnX&quot;</span>], $this-&gt;namedtag[<span class="stringliteral">&quot;SpawnY&quot;</span>], $this-&gt;namedtag[<span class="stringliteral">&quot;SpawnZ&quot;</span>], $level);
<a name="l01216"></a>01216                 }
<a name="l01217"></a>01217 
<a name="l01218"></a>01218                 $pk = <span class="keyword">new</span> StartGamePacket;
<a name="l01219"></a>01219                 $pk-&gt;seed = $this-&gt;getLevel()-&gt;getSeed();
<a name="l01220"></a>01220                 $pk-&gt;x = $this-&gt;x;
<a name="l01221"></a>01221                 $pk-&gt;y = $this-&gt;y;
<a name="l01222"></a>01222                 $pk-&gt;z = $this-&gt;z;
<a name="l01223"></a>01223                 $pk-&gt;spawnX = (int) $this-&gt;spawnPosition-&gt;x;
<a name="l01224"></a>01224                 $pk-&gt;spawnY = (<span class="keywordtype">int</span>) $this-&gt;spawnPosition-&gt;y;
<a name="l01225"></a>01225                 $pk-&gt;spawnZ = (int) $this-&gt;spawnPosition-&gt;z;
<a name="l01226"></a>01226                 $pk-&gt;generator = 1; <span class="comment">//0 old, 1 infinite, 2 flat</span>
<a name="l01227"></a>01227                 $pk-&gt;gamemode = $this-&gt;gamemode &amp; 0x01;
<a name="l01228"></a>01228                 $pk-&gt;eid = 0; <span class="comment">//Always use EntityID as zero for the actual player</span>
<a name="l01229"></a>01229                 $this-&gt;directDataPacket($pk);
<a name="l01230"></a>01230 
<a name="l01231"></a>01231                 $pk = <span class="keyword">new</span> SetTimePacket();
<a name="l01232"></a>01232                 $pk-&gt;time = $this-&gt;getLevel()-&gt;getTime();
<a name="l01233"></a>01233                 $this-&gt;directDataPacket($pk);
<a name="l01234"></a>01234 
<a name="l01235"></a>01235                 $pk = <span class="keyword">new</span> SetSpawnPositionPacket;
<a name="l01236"></a>01236                 $pk-&gt;x = (int) $this-&gt;spawnPosition-&gt;x;
<a name="l01237"></a>01237                 $pk-&gt;y = (<span class="keywordtype">int</span>) $this-&gt;spawnPosition-&gt;y;
<a name="l01238"></a>01238                 $pk-&gt;z = (int) $this-&gt;spawnPosition-&gt;z;
<a name="l01239"></a>01239                 $this-&gt;directDataPacket($pk);
<a name="l01240"></a>01240 
<a name="l01241"></a>01241                 $this-&gt;server-&gt;getLogger()-&gt;info(TextFormat::AQUA . $this-&gt;username . TextFormat::WHITE . <span class="stringliteral">&quot;[/&quot;</span> . $this-&gt;ip . <span class="stringliteral">&quot;:&quot;</span> . $this-&gt;port . <span class="stringliteral">&quot;] logged in with entity id &quot;</span> . $this-&gt;<span class="keywordtype">id</span> . <span class="stringliteral">&quot; at (&quot;</span> . $this-&gt;getLevel()-&gt;getName() . <span class="stringliteral">&quot;, &quot;</span> . round($this-&gt;x, 4) . <span class="stringliteral">&quot;, &quot;</span> . round($this-&gt;y, 4) . <span class="stringliteral">&quot;, &quot;</span> . round($this-&gt;z, 4) . <span class="stringliteral">&quot;)&quot;</span>);
<a name="l01242"></a>01242 
<a name="l01243"></a>01243 
<a name="l01244"></a>01244                 $this-&gt;orderChunks();
<a name="l01245"></a>01245                 $this-&gt;tasks[] = $this-&gt;server-&gt;getScheduler()-&gt;scheduleDelayedRepeatingTask(<span class="keyword">new</span> CallbackTask(array($this, <span class="stringliteral">&quot;orderChunks&quot;</span>)), 10, 40);
<a name="l01246"></a>01246                 $this-&gt;sendNextChunk();
<a name="l01247"></a>01247                 $this-&gt;tasks[] = $this-&gt;chunkLoadTask = $this-&gt;server-&gt;getScheduler()-&gt;scheduleRepeatingTask(<span class="keyword">new</span> CallbackTask(array($this, <span class="stringliteral">&quot;sendNextChunk&quot;</span>)), 1);
<a name="l01248"></a>01248 
<a name="l01249"></a>01249                 <span class="keywordflow">break</span>;
<a name="l01250"></a>01250             <span class="keywordflow">case</span> ProtocolInfo::ROTATE_HEAD_PACKET:
<a name="l01251"></a>01251                 <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">false</span>){
<a name="l01252"></a>01252                     <span class="keywordflow">break</span>;
<a name="l01253"></a>01253                 }
<a name="l01254"></a>01254                 $this-&gt;setRotation($packet-&gt;yaw, $this-&gt;pitch);
<a name="l01255"></a>01255                 <span class="keywordflow">break</span>;
<a name="l01256"></a>01256             <span class="keywordflow">case</span> ProtocolInfo::MOVE_PLAYER_PACKET:
<a name="l01257"></a>01257                 <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">false</span>){
<a name="l01258"></a>01258                     <span class="keywordflow">break</span>;
<a name="l01259"></a>01259                 }
<a name="l01260"></a>01260 
<a name="l01261"></a>01261                 $newPos = <span class="keyword">new</span> Vector3($packet-&gt;x, $packet-&gt;y, $packet-&gt;z);
<a name="l01262"></a>01262                 <span class="comment">/*if($this-&gt;forceMovement instanceof Vector3){</span>
<a name="l01263"></a>01263 <span class="comment">                    if($this-&gt;forceMovement-&gt;distance($newPos) &lt;= 0.7){</span>
<a name="l01264"></a>01264 <span class="comment">                        $this-&gt;forceMovement = false;</span>
<a name="l01265"></a>01265 <span class="comment">                    }else{</span>
<a name="l01266"></a>01266 <span class="comment">                        $this-&gt;setPosition($this-&gt;forceMovement);</span>
<a name="l01267"></a>01267 <span class="comment">                    }</span>
<a name="l01268"></a>01268 <span class="comment">                }*/</span>
<a name="l01269"></a>01269                 <span class="comment">/*$speed = $this-&gt;entity-&gt;getSpeedMeasure();</span>
<a name="l01270"></a>01270 <span class="comment">                if($this-&gt;blocked === true or ($this-&gt;server-&gt;api-&gt;getProperty(&quot;allow-flight&quot;) !== true and (($speed &gt; 9 and ($this-&gt;gamemode &amp; 0x01) === 0x00) or $speed &gt; 20 or $this-&gt;entity-&gt;distance($newPos) &gt; 7)) or $this-&gt;server-&gt;api-&gt;handle(&quot;player.move&quot;, $this-&gt;entity) === false){</span>
<a name="l01271"></a>01271 <span class="comment">                    if($this-&gt;lastCorrect instanceof Vector3){</span>
<a name="l01272"></a>01272 <span class="comment">                        $this-&gt;teleport($this-&gt;lastCorrect, $this-&gt;entity-&gt;yaw, $this-&gt;entity-&gt;pitch, false);</span>
<a name="l01273"></a>01273 <span class="comment">                    }</span>
<a name="l01274"></a>01274 <span class="comment">                    if($this-&gt;blocked !== true){</span>
<a name="l01275"></a>01275 <span class="comment">                        $this-&gt;server-&gt;getLogger()-&gt;warning($this-&gt;username.&quot; moved too quickly!&quot;);</span>
<a name="l01276"></a>01276 <span class="comment">                    }</span>
<a name="l01277"></a>01277 <span class="comment">                }else{*/</span>
<a name="l01278"></a>01278 
<a name="l01279"></a>01279                 <span class="keywordflow">if</span>(!$this-&gt;setPositionAndRotation($newPos, $packet-&gt;yaw, $packet-&gt;pitch)){
<a name="l01280"></a>01280                     $pk = <span class="keyword">new</span> MovePlayerPacket();
<a name="l01281"></a>01281                     $pk-&gt;eid = 0;
<a name="l01282"></a>01282                     $pk-&gt;x = $this-&gt;x;
<a name="l01283"></a>01283                     $pk-&gt;y = $this-&gt;y;
<a name="l01284"></a>01284                     $pk-&gt;z = $this-&gt;z;
<a name="l01285"></a>01285                     $pk-&gt;bodyYaw = $this-&gt;yaw;
<a name="l01286"></a>01286                     $pk-&gt;pitch = $this-&gt;pitch;
<a name="l01287"></a>01287                     $pk-&gt;yaw = $this-&gt;yaw;
<a name="l01288"></a>01288                     $this-&gt;directDataPacket($pk);
<a name="l01289"></a>01289                 }
<a name="l01290"></a>01290                 <span class="comment">//}</span>
<a name="l01291"></a>01291 
<a name="l01292"></a>01292                 <span class="keywordflow">break</span>;
<a name="l01293"></a>01293             <span class="keywordflow">case</span> ProtocolInfo::PLAYER_EQUIPMENT_PACKET:
<a name="l01294"></a>01294                 <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">false</span>){
<a name="l01295"></a>01295                     <span class="keywordflow">break</span>;
<a name="l01296"></a>01296                 }
<a name="l01297"></a>01297 
<a name="l01298"></a>01298                 <span class="keywordflow">if</span>($packet-&gt;slot === 0x28 or $packet-&gt;slot === 0 or $packet-&gt;slot === 255){ <span class="comment">//0 for 0.8.0 compatibility</span>
<a name="l01299"></a>01299                     $packet-&gt;slot = -1; <span class="comment">//Air</span>
<a name="l01300"></a>01300                 }<span class="keywordflow">else</span>{
<a name="l01301"></a>01301                     $packet-&gt;slot -= 9; <span class="comment">//Get real block slot</span>
<a name="l01302"></a>01302                 }
<a name="l01303"></a>01303 
<a name="l01304"></a>01304                 <span class="keywordflow">if</span>(($this-&gt;gamemode &amp; 0x01) === 1){ <span class="comment">//Creative mode match</span>
<a name="l01305"></a>01305                     $item = Item::get($packet-&gt;item, $packet-&gt;meta, 1);
<a name="l01306"></a>01306                     $packet-&gt;slot = $this-&gt;getCreativeBlock($item);
<a name="l01307"></a>01307                 }<span class="keywordflow">else</span>{
<a name="l01308"></a>01308                     $item = $this-&gt;inventory-&gt;getItem($packet-&gt;slot);
<a name="l01309"></a>01309                 }
<a name="l01310"></a>01310 
<a name="l01311"></a>01311                 <span class="keywordflow">if</span>(!isset($item) or $packet-&gt;slot === -1 or $item-&gt;getID() !== $packet-&gt;item or $item-&gt;getDamage() !== $packet-&gt;meta){
<a name="l01312"></a>01312                     $this-&gt;inventory-&gt;sendContents($this);
<a name="l01313"></a>01313                     <span class="keywordflow">break</span>;
<a name="l01314"></a>01314                 }elseif(($this-&gt;gamemode &amp; 0x01) === Player::CREATIVE){
<a name="l01315"></a>01315                     $item = Item::get(
<a name="l01316"></a>01316                         Block::$creative[$packet-&gt;slot][0],
<a name="l01317"></a>01317                         Block::$creative[$packet-&gt;slot][1],
<a name="l01318"></a>01318                         1
<a name="l01319"></a>01319                     );
<a name="l01320"></a>01320                     $this-&gt;inventory-&gt;setHeldItemSlot(0);
<a name="l01321"></a>01321                     $this-&gt;inventory-&gt;setItemInHand($item);
<a name="l01322"></a>01322                 }<span class="keywordflow">else</span>{
<a name="l01323"></a>01323                     $this-&gt;inventory-&gt;setHeldItemSlot($packet-&gt;slot);
<a name="l01324"></a>01324                 }
<a name="l01325"></a>01325 
<a name="l01326"></a>01326                 $this-&gt;inventory-&gt;sendHeldItem($this-&gt;hasSpawned);
<a name="l01327"></a>01327 
<a name="l01328"></a>01328                 <span class="keywordflow">if</span>($this-&gt;inAction === <span class="keyword">true</span>){
<a name="l01329"></a>01329                     $this-&gt;inAction = <span class="keyword">false</span>;
<a name="l01330"></a>01330                     <span class="comment">//$this-&gt;entity-&gt;updateMetadata();</span>
<a name="l01331"></a>01331                 }
<a name="l01332"></a>01332                 <span class="keywordflow">break</span>;
<a name="l01333"></a>01333             <span class="keywordflow">case</span> ProtocolInfo::USE_ITEM_PACKET:
<a name="l01334"></a>01334                 $blockVector = <span class="keyword">new</span> Vector3($packet-&gt;x, $packet-&gt;y, $packet-&gt;z);
<a name="l01335"></a>01335 
<a name="l01336"></a>01336                 $this-&gt;craftingType = 0;
<a name="l01337"></a>01337 
<a name="l01338"></a>01338                 <span class="keywordflow">if</span>(($this-&gt;spawned === <span class="keyword">false</span> or $this-&gt;blocked === <span class="keyword">true</span>) and $packet-&gt;face &gt;= 0 and $packet-&gt;face &lt;= 5){
<a name="l01339"></a>01339                     $target = $this-&gt;getLevel()-&gt;getBlock($blockVector);
<a name="l01340"></a>01340                     $block = $target-&gt;getSide($packet-&gt;face);
<a name="l01341"></a>01341 
<a name="l01342"></a>01342                     $pk = <span class="keyword">new</span> UpdateBlockPacket;
<a name="l01343"></a>01343                     $pk-&gt;x = $target-&gt;x;
<a name="l01344"></a>01344                     $pk-&gt;y = $target-&gt;y;
<a name="l01345"></a>01345                     $pk-&gt;z = $target-&gt;z;
<a name="l01346"></a>01346                     $pk-&gt;block = $target-&gt;getID();
<a name="l01347"></a>01347                     $pk-&gt;meta = $target-&gt;getDamage();
<a name="l01348"></a>01348                     $this-&gt;dataPacket($pk);
<a name="l01349"></a>01349 
<a name="l01350"></a>01350                     $pk = <span class="keyword">new</span> UpdateBlockPacket;
<a name="l01351"></a>01351                     $pk-&gt;x = $block-&gt;x;
<a name="l01352"></a>01352                     $pk-&gt;y = $block-&gt;y;
<a name="l01353"></a>01353                     $pk-&gt;z = $block-&gt;z;
<a name="l01354"></a>01354                     $pk-&gt;block = $block-&gt;getID();
<a name="l01355"></a>01355                     $pk-&gt;meta = $block-&gt;getDamage();
<a name="l01356"></a>01356                     $this-&gt;dataPacket($pk);
<a name="l01357"></a>01357                     <span class="keywordflow">break</span>;
<a name="l01358"></a>01358                 }
<a name="l01359"></a>01359 
<a name="l01360"></a>01360                 $packet-&gt;eid = $this-&gt;id;
<a name="l01361"></a>01361 
<a name="l01362"></a>01362                 <span class="keywordflow">if</span>($packet-&gt;face &gt;= 0 and $packet-&gt;face &lt;= 5){ <span class="comment">//Use Block, place</span>
<a name="l01363"></a>01363                     <span class="keywordflow">if</span>($this-&gt;inAction === <span class="keyword">true</span>){
<a name="l01364"></a>01364                         $this-&gt;inAction = <span class="keyword">false</span>;
<a name="l01365"></a>01365                         <span class="comment">//$this-&gt;entity-&gt;updateMetadata();</span>
<a name="l01366"></a>01366                     }
<a name="l01367"></a>01367 
<a name="l01368"></a>01368                     <span class="keywordflow">if</span>($blockVector-&gt;distance($this) &gt; 10){
<a name="l01369"></a>01369 
<a name="l01370"></a>01370                     }elseif(($this-&gt;gamemode &amp; 0x01) === 1){
<a name="l01371"></a>01371                         $item = $this-&gt;inventory-&gt;getItemInHand();;
<a name="l01372"></a>01372                         <span class="keywordflow">if</span>($this-&gt;getLevel()-&gt;useItemOn($blockVector, $item, $packet-&gt;face, $packet-&gt;fx, $packet-&gt;fy, $packet-&gt;fz, $this) === <span class="keyword">true</span>){
<a name="l01373"></a>01373                             <span class="keywordflow">break</span>;
<a name="l01374"></a>01374                         }
<a name="l01375"></a>01375                     }elseif($this-&gt;inventory-&gt;getItemInHand()-&gt;getID() !== $packet-&gt;item or ($this-&gt;inventory-&gt;getItemInHand()-&gt;isTool() === <span class="keyword">false</span> and $this-&gt;inventory-&gt;getItemInHand()-&gt;getDamage() !== $packet-&gt;meta)){
<a name="l01376"></a>01376                         $this-&gt;inventory-&gt;sendHeldItem($this);
<a name="l01377"></a>01377                     }<span class="keywordflow">else</span>{
<a name="l01378"></a>01378                         $item = clone $this-&gt;inventory-&gt;getItemInHand();
<a name="l01379"></a>01379                         <span class="comment">//TODO: Implement adventure mode checks</span>
<a name="l01380"></a>01380                         <span class="keywordflow">if</span>($this-&gt;getLevel()-&gt;useItemOn($blockVector, $item, $packet-&gt;face, $packet-&gt;fx, $packet-&gt;fy, $packet-&gt;fz, $this) === <span class="keyword">true</span>){
<a name="l01381"></a>01381                             $this-&gt;inventory-&gt;setItemInHand($item);
<a name="l01382"></a>01382                             $this-&gt;inventory-&gt;sendHeldItem($this-&gt;hasSpawned);
<a name="l01383"></a>01383                             <span class="keywordflow">break</span>;
<a name="l01384"></a>01384                         }
<a name="l01385"></a>01385                     }
<a name="l01386"></a>01386                     $target = $this-&gt;getLevel()-&gt;getBlock($blockVector);
<a name="l01387"></a>01387                     $block = $target-&gt;getSide($packet-&gt;face);
<a name="l01388"></a>01388 
<a name="l01389"></a>01389                     $pk = <span class="keyword">new</span> UpdateBlockPacket;
<a name="l01390"></a>01390                     $pk-&gt;x = $target-&gt;x;
<a name="l01391"></a>01391                     $pk-&gt;y = $target-&gt;y;
<a name="l01392"></a>01392                     $pk-&gt;z = $target-&gt;z;
<a name="l01393"></a>01393                     $pk-&gt;block = $target-&gt;getID();
<a name="l01394"></a>01394                     $pk-&gt;meta = $target-&gt;getDamage();
<a name="l01395"></a>01395                     $this-&gt;dataPacket($pk);
<a name="l01396"></a>01396 
<a name="l01397"></a>01397                     $pk = <span class="keyword">new</span> UpdateBlockPacket;
<a name="l01398"></a>01398                     $pk-&gt;x = $block-&gt;x;
<a name="l01399"></a>01399                     $pk-&gt;y = $block-&gt;y;
<a name="l01400"></a>01400                     $pk-&gt;z = $block-&gt;z;
<a name="l01401"></a>01401                     $pk-&gt;block = $block-&gt;getID();
<a name="l01402"></a>01402                     $pk-&gt;meta = $block-&gt;getDamage();
<a name="l01403"></a>01403                     $this-&gt;dataPacket($pk);
<a name="l01404"></a>01404                     <span class="keywordflow">break</span>;
<a name="l01405"></a>01405                 }elseif($packet-&gt;face === 0xff){
<a name="l01406"></a>01406                     <span class="comment">//TODO: add event</span>
<a name="l01407"></a>01407                     $this-&gt;inAction = <span class="keyword">true</span>;
<a name="l01408"></a>01408                     $this-&gt;startAction = microtime(<span class="keyword">true</span>);
<a name="l01409"></a>01409                     <span class="comment">//$this-&gt;updateMetadata();</span>
<a name="l01410"></a>01410                 }
<a name="l01411"></a>01411                 <span class="keywordflow">break</span>;
<a name="l01412"></a>01412             <span class="keywordflow">case</span> ProtocolInfo::PLAYER_ACTION_PACKET:
<a name="l01413"></a>01413                 <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">false</span> or $this-&gt;blocked === <span class="keyword">true</span>){
<a name="l01414"></a>01414                     <span class="keywordflow">break</span>;
<a name="l01415"></a>01415                 }
<a name="l01416"></a>01416 
<a name="l01417"></a>01417                 $this-&gt;craftingType = 0;
<a name="l01418"></a>01418                 $packet-&gt;eid = $this-&gt;id;
<a name="l01419"></a>01419 
<a name="l01420"></a>01420                 <span class="keywordflow">switch</span>($packet-&gt;action){
<a name="l01421"></a>01421                     <span class="comment">/*case 5: //Shot arrow</span>
<a name="l01422"></a>01422 <span class="comment">                        if($this-&gt;entity-&gt;inAction === true){</span>
<a name="l01423"></a>01423 <span class="comment">                            if($this-&gt;getSlot($this-&gt;getCurrentEquipment())-&gt;getID() === BOW){</span>
<a name="l01424"></a>01424 <span class="comment">                                if($this-&gt;startAction !== false){</span>
<a name="l01425"></a>01425 <span class="comment">                                    $time = microtime(true) - $this-&gt;startAction;</span>
<a name="l01426"></a>01426 <span class="comment">                                    $d = array(</span>
<a name="l01427"></a>01427 <span class="comment">                                        &quot;x&quot; =&gt; $this-&gt;entity-&gt;x,</span>
<a name="l01428"></a>01428 <span class="comment">                                        &quot;y&quot; =&gt; $this-&gt;entity-&gt;y + 1.6,</span>
<a name="l01429"></a>01429 <span class="comment">                                        &quot;z&quot; =&gt; $this-&gt;entity-&gt;z,</span>
<a name="l01430"></a>01430 <span class="comment">                                    );</span>
<a name="l01431"></a>01431 <span class="comment">                                    $e = $this-&gt;server-&gt;api-&gt;entity-&gt;add($this-&gt;getLevel(), ENTITY_OBJECT, OBJECT_ARROW, $d);</span>
<a name="l01432"></a>01432 <span class="comment">                                    $e-&gt;yaw = $this-&gt;entity-&gt;yaw;</span>
<a name="l01433"></a>01433 <span class="comment">                                    $e-&gt;pitch = $this-&gt;entity-&gt;pitch;</span>
<a name="l01434"></a>01434 <span class="comment">                                    $rotation = ($this-&gt;entity-&gt;yaw - 90) % 360;</span>
<a name="l01435"></a>01435 <span class="comment">                                    if($rotation &lt; 0){</span>
<a name="l01436"></a>01436 <span class="comment">                                        $rotation = (360 + $rotation);</span>
<a name="l01437"></a>01437 <span class="comment">                                    }</span>
<a name="l01438"></a>01438 <span class="comment">                                    $rotation = ($rotation + 180);</span>
<a name="l01439"></a>01439 <span class="comment">                                    if($rotation &gt;= 360){</span>
<a name="l01440"></a>01440 <span class="comment">                                        $rotation = ($rotation - 360);</span>
<a name="l01441"></a>01441 <span class="comment">                                    }</span>
<a name="l01442"></a>01442 <span class="comment">                                    $X = 1;</span>
<a name="l01443"></a>01443 <span class="comment">                                    $Z = 1;</span>
<a name="l01444"></a>01444 <span class="comment">                                    $overturn = false;</span>
<a name="l01445"></a>01445 <span class="comment">                                    if(0 &lt;= $rotation and $rotation &lt; 90){</span>
<a name="l01446"></a>01446 <span class="comment"></span>
<a name="l01447"></a>01447 <span class="comment">                                    }elseif(90 &lt;= $rotation and $rotation &lt; 180){</span>
<a name="l01448"></a>01448 <span class="comment">                                        $rotation -= 90;</span>
<a name="l01449"></a>01449 <span class="comment">                                        $X = (-1);</span>
<a name="l01450"></a>01450 <span class="comment">                                        $overturn = true;</span>
<a name="l01451"></a>01451 <span class="comment">                                    }elseif(180 &lt;= $rotation and $rotation &lt; 270){</span>
<a name="l01452"></a>01452 <span class="comment">                                        $rotation -= 180;</span>
<a name="l01453"></a>01453 <span class="comment">                                        $X = (-1);</span>
<a name="l01454"></a>01454 <span class="comment">                                        $Z = (-1);</span>
<a name="l01455"></a>01455 <span class="comment">                                    }elseif(270 &lt;= $rotation and $rotation &lt; 360){</span>
<a name="l01456"></a>01456 <span class="comment">                                        $rotation -= 270;</span>
<a name="l01457"></a>01457 <span class="comment">                                        $Z = (-1);</span>
<a name="l01458"></a>01458 <span class="comment">                                        $overturn = true;</span>
<a name="l01459"></a>01459 <span class="comment">                                    }</span>
<a name="l01460"></a>01460 <span class="comment">                                    $rad = deg2rad($rotation);</span>
<a name="l01461"></a>01461 <span class="comment">                                    $pitch = (-($this-&gt;entity-&gt;pitch));</span>
<a name="l01462"></a>01462 <span class="comment">                                    $speed = 80;</span>
<a name="l01463"></a>01463 <span class="comment">                                    $speedY = (sin(deg2rad($pitch)) * $speed);</span>
<a name="l01464"></a>01464 <span class="comment">                                    $speedXZ = (cos(deg2rad($pitch)) * $speed);</span>
<a name="l01465"></a>01465 <span class="comment">                                    if($overturn){</span>
<a name="l01466"></a>01466 <span class="comment">                                        $speedX = (sin($rad) * $speedXZ * $X);</span>
<a name="l01467"></a>01467 <span class="comment">                                        $speedZ = (cos($rad) * $speedXZ * $Z);</span>
<a name="l01468"></a>01468 <span class="comment">                                    }</span>
<a name="l01469"></a>01469 <span class="comment">                                    else{</span>
<a name="l01470"></a>01470 <span class="comment">                                        $speedX = (cos($rad) * $speedXZ * $X);</span>
<a name="l01471"></a>01471 <span class="comment">                                        $speedZ = (sin($rad) * $speedXZ * $Z);</span>
<a name="l01472"></a>01472 <span class="comment">                                    }</span>
<a name="l01473"></a>01473 <span class="comment">                                    $e-&gt;speedX = $speedX;</span>
<a name="l01474"></a>01474 <span class="comment">                                    $e-&gt;speedZ = $speedZ;</span>
<a name="l01475"></a>01475 <span class="comment">                                    $e-&gt;speedY = $speedY;</span>
<a name="l01476"></a>01476 <span class="comment">                                    $e-&gt;spawnToAll();</span>
<a name="l01477"></a>01477 <span class="comment">                                }</span>
<a name="l01478"></a>01478 <span class="comment">                            }</span>
<a name="l01479"></a>01479 <span class="comment">                        }</span>
<a name="l01480"></a>01480 <span class="comment">                        $this-&gt;startAction = false;</span>
<a name="l01481"></a>01481 <span class="comment">                        $this-&gt;entity-&gt;inAction = false;</span>
<a name="l01482"></a>01482 <span class="comment">                        $this-&gt;entity-&gt;updateMetadata();</span>
<a name="l01483"></a>01483 <span class="comment">                        break;</span>
<a name="l01484"></a>01484 <span class="comment">                    */</span>
<a name="l01485"></a>01485                     <span class="keywordflow">case</span> 6: <span class="comment">//get out of the bed</span>
<a name="l01486"></a>01486                         $this-&gt;stopSleep();
<a name="l01487"></a>01487                         <span class="keywordflow">break</span>;
<a name="l01488"></a>01488                 }
<a name="l01489"></a>01489                 <span class="keywordflow">break</span>;
<a name="l01490"></a>01490             <span class="keywordflow">case</span> ProtocolInfo::REMOVE_BLOCK_PACKET:
<a name="l01491"></a>01491                 <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">false</span> or $this-&gt;blocked === <span class="keyword">true</span>){
<a name="l01492"></a>01492                     <span class="keywordflow">break</span>;
<a name="l01493"></a>01493                 }
<a name="l01494"></a>01494                 $this-&gt;craftingType = 0;
<a name="l01495"></a>01495 
<a name="l01496"></a>01496                 $vector = <span class="keyword">new</span> Vector3($packet-&gt;x, $packet-&gt;y, $packet-&gt;z);
<a name="l01497"></a>01497 
<a name="l01498"></a>01498 
<a name="l01499"></a>01499                 <span class="keywordflow">if</span>(($this-&gt;gamemode &amp; 0x01) === 1){
<a name="l01500"></a>01500                     $item = $this-&gt;inventory-&gt;getItemInHand();
<a name="l01501"></a>01501                 }<span class="keywordflow">else</span>{
<a name="l01502"></a>01502                     $item = clone $this-&gt;inventory-&gt;getItemInHand();
<a name="l01503"></a>01503                 }
<a name="l01504"></a>01504 
<a name="l01505"></a>01505                 <span class="keywordflow">if</span>($this-&gt;getLevel()-&gt;useBreakOn($vector, $item, $this) === <span class="keyword">true</span>){
<a name="l01506"></a>01506                     <span class="keywordflow">if</span>(($this-&gt;gamemode &amp; 0x01) === 0){
<a name="l01507"></a>01507                         $this-&gt;inventory-&gt;setItemInHand($item);
<a name="l01508"></a>01508                         $this-&gt;inventory-&gt;sendHeldItem($this-&gt;hasSpawned);
<a name="l01509"></a>01509                     }
<a name="l01510"></a>01510                     <span class="keywordflow">break</span>;
<a name="l01511"></a>01511                 }
<a name="l01512"></a>01512                 $target = $this-&gt;getLevel()-&gt;getBlock($vector);
<a name="l01513"></a>01513                 $tile = $this-&gt;getLevel()-&gt;getTile($vector);
<a name="l01514"></a>01514                 $pk = <span class="keyword">new</span> UpdateBlockPacket;
<a name="l01515"></a>01515                 $pk-&gt;x = $target-&gt;x;
<a name="l01516"></a>01516                 $pk-&gt;y = $target-&gt;y;
<a name="l01517"></a>01517                 $pk-&gt;z = $target-&gt;z;
<a name="l01518"></a>01518                 $pk-&gt;block = $target-&gt;getID();
<a name="l01519"></a>01519                 $pk-&gt;meta = $target-&gt;getDamage();
<a name="l01520"></a>01520                 $this-&gt;dataPacket($pk);
<a name="l01521"></a>01521                 <span class="comment">//TODO: priority</span>
<a name="l01522"></a>01522                 <span class="keywordflow">if</span>($tile instanceof Spawnable){
<a name="l01523"></a>01523                     $tile-&gt;spawnTo($this);
<a name="l01524"></a>01524                 }
<a name="l01525"></a>01525                 <span class="keywordflow">break</span>;
<a name="l01526"></a>01526             <span class="keywordflow">case</span> ProtocolInfo::PLAYER_ARMOR_EQUIPMENT_PACKET:
<a name="l01527"></a>01527                 <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">false</span> or $this-&gt;blocked === <span class="keyword">true</span>){
<a name="l01528"></a>01528                     <span class="keywordflow">break</span>;
<a name="l01529"></a>01529                 }
<a name="l01530"></a>01530 
<a name="l01531"></a>01531                 <span class="keywordflow">for</span>($i = 0; $i &lt; 4; ++$i){
<a name="l01532"></a>01532                     $s = $packet-&gt;slots[$i];
<a name="l01533"></a>01533                     <span class="keywordflow">if</span>($s === 0 or $s === 255){
<a name="l01534"></a>01534                         $s = Item::get(Item::AIR, 0, 0);
<a name="l01535"></a>01535                     }<span class="keywordflow">else</span>{
<a name="l01536"></a>01536                         $s = Item::get($s + 256, 0, 1);
<a name="l01537"></a>01537                     }
<a name="l01538"></a>01538                     $slot = $this-&gt;inventory-&gt;getArmorItem($i);
<a name="l01539"></a>01539                     <span class="keywordflow">if</span>($slot-&gt;getID() !== Item::AIR and $s-&gt;getID() === Item::AIR){
<a name="l01540"></a>01540                         $this-&gt;inventory-&gt;setArmorItem($i, Item::get(Item::AIR, 0, 0));
<a name="l01541"></a>01541                     }elseif($s-&gt;getID() !== Item::AIR and $slot-&gt;getID() === Item::AIR and ($sl = $this-&gt;inventory-&gt;first($s)) !== -1){
<a name="l01542"></a>01542                         <span class="keywordflow">if</span>($this-&gt;inventory-&gt;setArmorItem($i, $this-&gt;inventory-&gt;getItem($sl)) === <span class="keyword">false</span>){
<a name="l01543"></a>01543                             $this-&gt;inventory-&gt;sendContents($this);
<a name="l01544"></a>01544                         }<span class="keywordflow">else</span>{
<a name="l01545"></a>01545                             $this-&gt;inventory-&gt;setItem($sl, Item::get(Item::AIR, 0, 0));
<a name="l01546"></a>01546                         }
<a name="l01547"></a>01547                     }elseif($s-&gt;getID() !== Item::AIR and $slot-&gt;getID() !== Item::AIR and ($slot-&gt;getID() !== $s-&gt;getID() or $slot-&gt;getDamage() !== $s-&gt;getDamage()) and ($sl = $this-&gt;inventory-&gt;first($s)) !== -1){
<a name="l01548"></a>01548                         <span class="keywordflow">if</span>($this-&gt;inventory-&gt;setArmorItem($i, $this-&gt;inventory-&gt;getItem($sl)) === <span class="keyword">false</span>){
<a name="l01549"></a>01549                             $this-&gt;inventory-&gt;sendContents($this);
<a name="l01550"></a>01550                         }<span class="keywordflow">else</span>{
<a name="l01551"></a>01551                             $this-&gt;inventory-&gt;setItem($sl, $slot);
<a name="l01552"></a>01552                         }
<a name="l01553"></a>01553                     }
<a name="l01554"></a>01554                 }
<a name="l01555"></a>01555 
<a name="l01556"></a>01556                 <span class="keywordflow">if</span>($this-&gt;inAction === <span class="keyword">true</span>){
<a name="l01557"></a>01557                     $this-&gt;inAction = <span class="keyword">false</span>;
<a name="l01558"></a>01558                     <span class="comment">//$this-&gt;entity-&gt;updateMetadata();</span>
<a name="l01559"></a>01559                 }
<a name="l01560"></a>01560                 <span class="keywordflow">break</span>;
<a name="l01561"></a>01561             <span class="comment">/*case ProtocolInfo::INTERACT_PACKET:</span>
<a name="l01562"></a>01562 <span class="comment">                if($this-&gt;spawned === false){</span>
<a name="l01563"></a>01563 <span class="comment">                    break;</span>
<a name="l01564"></a>01564 <span class="comment">                }</span>
<a name="l01565"></a>01565 <span class="comment"></span>
<a name="l01566"></a>01566 <span class="comment">                $this-&gt;craftingType = 0;</span>
<a name="l01567"></a>01567 <span class="comment">                $packet-&gt;eid = $this-&gt;id;</span>
<a name="l01568"></a>01568 <span class="comment">                $data = [];</span>
<a name="l01569"></a>01569 <span class="comment">                $data[&quot;target&quot;] = $packet-&gt;target;</span>
<a name="l01570"></a>01570 <span class="comment">                $data[&quot;eid&quot;] = $packet-&gt;eid;</span>
<a name="l01571"></a>01571 <span class="comment">                $data[&quot;action&quot;] = $packet-&gt;action;</span>
<a name="l01572"></a>01572 <span class="comment">                $target = Entity::get($packet-&gt;target);</span>
<a name="l01573"></a>01573 <span class="comment">                if($target instanceof Entity and $this-&gt;gamemode !== VIEW and $this-&gt;blocked === false and ($target instanceof Entity) and $this-&gt;entity-&gt;distance($target) &lt;= 8){</span>
<a name="l01574"></a>01574 <span class="comment">                    $data[&quot;targetentity&quot;] = $target;</span>
<a name="l01575"></a>01575 <span class="comment">                    $data[&quot;entity&quot;] = $this-&gt;entity;</span>
<a name="l01576"></a>01576 <span class="comment">                if($target instanceof Player and ($this-&gt;server-&gt;api-&gt;getProperty(&quot;pvp&quot;) == false or $this-&gt;server-&gt;difficulty &lt;= 0 or ($target-&gt;player-&gt;gamemode &amp; 0x01) === 0x01)){</span>
<a name="l01577"></a>01577 <span class="comment">                    break;</span>
<a name="l01578"></a>01578 <span class="comment">                }elseif($this-&gt;server-&gt;handle(&quot;player.interact&quot;, $data) !== false){</span>
<a name="l01579"></a>01579 <span class="comment">                        $slot = $this-&gt;getSlot($this-&gt;getCurrentEquipment());</span>
<a name="l01580"></a>01580 <span class="comment">                        switch($slot-&gt;getID()){</span>
<a name="l01581"></a>01581 <span class="comment">                            case WOODEN_SWORD:</span>
<a name="l01582"></a>01582 <span class="comment">                            case GOLD_SWORD:</span>
<a name="l01583"></a>01583 <span class="comment">                                $damage = 4;</span>
<a name="l01584"></a>01584 <span class="comment">                                break;</span>
<a name="l01585"></a>01585 <span class="comment">                            case STONE_SWORD:</span>
<a name="l01586"></a>01586 <span class="comment">                                $damage = 5;</span>
<a name="l01587"></a>01587 <span class="comment">                                break;</span>
<a name="l01588"></a>01588 <span class="comment">                            case IRON_SWORD:</span>
<a name="l01589"></a>01589 <span class="comment">                                $damage = 6;</span>
<a name="l01590"></a>01590 <span class="comment">                                break;</span>
<a name="l01591"></a>01591 <span class="comment">                            case DIAMOND_SWORD:</span>
<a name="l01592"></a>01592 <span class="comment">                                $damage = 7;</span>
<a name="l01593"></a>01593 <span class="comment">                                break;</span>
<a name="l01594"></a>01594 <span class="comment"></span>
<a name="l01595"></a>01595 <span class="comment">                            case WOODEN_AXE:</span>
<a name="l01596"></a>01596 <span class="comment">                            case GOLD_AXE:</span>
<a name="l01597"></a>01597 <span class="comment">                                $damage = 3;</span>
<a name="l01598"></a>01598 <span class="comment">                                break;</span>
<a name="l01599"></a>01599 <span class="comment">                            case STONE_AXE:</span>
<a name="l01600"></a>01600 <span class="comment">                                $damage = 4;</span>
<a name="l01601"></a>01601 <span class="comment">                                break;</span>
<a name="l01602"></a>01602 <span class="comment">                            case IRON_AXE:</span>
<a name="l01603"></a>01603 <span class="comment">                                $damage = 5;</span>
<a name="l01604"></a>01604 <span class="comment">                                break;</span>
<a name="l01605"></a>01605 <span class="comment">                            case DIAMOND_AXE:</span>
<a name="l01606"></a>01606 <span class="comment">                                $damage = 6;</span>
<a name="l01607"></a>01607 <span class="comment">                                break;</span>
<a name="l01608"></a>01608 <span class="comment"></span>
<a name="l01609"></a>01609 <span class="comment">                            case WOODEN_PICKAXE:</span>
<a name="l01610"></a>01610 <span class="comment">                            case GOLD_PICKAXE:</span>
<a name="l01611"></a>01611 <span class="comment">                                $damage = 2;</span>
<a name="l01612"></a>01612 <span class="comment">                                break;</span>
<a name="l01613"></a>01613 <span class="comment">                            case STONE_PICKAXE:</span>
<a name="l01614"></a>01614 <span class="comment">                                $damage = 3;</span>
<a name="l01615"></a>01615 <span class="comment">                                break;</span>
<a name="l01616"></a>01616 <span class="comment">                            case IRON_PICKAXE:</span>
<a name="l01617"></a>01617 <span class="comment">                                $damage = 4;</span>
<a name="l01618"></a>01618 <span class="comment">                                break;</span>
<a name="l01619"></a>01619 <span class="comment">                            case DIAMOND_PICKAXE:</span>
<a name="l01620"></a>01620 <span class="comment">                                $damage = 5;</span>
<a name="l01621"></a>01621 <span class="comment">                                break;</span>
<a name="l01622"></a>01622 <span class="comment"></span>
<a name="l01623"></a>01623 <span class="comment">                            case WOODEN_SHOVEL:</span>
<a name="l01624"></a>01624 <span class="comment">                            case GOLD_SHOVEL:</span>
<a name="l01625"></a>01625 <span class="comment">                                $damage = 1;</span>
<a name="l01626"></a>01626 <span class="comment">                                break;</span>
<a name="l01627"></a>01627 <span class="comment">                            case STONE_SHOVEL:</span>
<a name="l01628"></a>01628 <span class="comment">                                $damage = 2;</span>
<a name="l01629"></a>01629 <span class="comment">                                break;</span>
<a name="l01630"></a>01630 <span class="comment">                            case IRON_SHOVEL:</span>
<a name="l01631"></a>01631 <span class="comment">                                $damage = 3;</span>
<a name="l01632"></a>01632 <span class="comment">                                break;</span>
<a name="l01633"></a>01633 <span class="comment">                            case DIAMOND_SHOVEL:</span>
<a name="l01634"></a>01634 <span class="comment">                                $damage = 4;</span>
<a name="l01635"></a>01635 <span class="comment">                                break;</span>
<a name="l01636"></a>01636 <span class="comment"></span>
<a name="l01637"></a>01637 <span class="comment">                            default:</span>
<a name="l01638"></a>01638 <span class="comment">                                $damage = 1;//$this-&gt;server-&gt;difficulty;</span>
<a name="l01639"></a>01639 <span class="comment">                        }</span>
<a name="l01640"></a>01640 <span class="comment">                        $target-&gt;harm($damage, $this-&gt;id);</span>
<a name="l01641"></a>01641 <span class="comment">                        if($slot-&gt;isTool() === true and ($this-&gt;gamemode &amp; 0x01) === 0){</span>
<a name="l01642"></a>01642 <span class="comment">                            if($slot-&gt;useOn($target) and $slot-&gt;getDamage() &gt;= $slot-&gt;getMaxDurability()){</span>
<a name="l01643"></a>01643 <span class="comment">                                $this-&gt;setSlot($this-&gt;getCurrentEquipment(), new Item(AIR, 0, 0));</span>
<a name="l01644"></a>01644 <span class="comment">                            }</span>
<a name="l01645"></a>01645 <span class="comment">                        }</span>
<a name="l01646"></a>01646 <span class="comment">                    }</span>
<a name="l01647"></a>01647 <span class="comment">                }</span>
<a name="l01648"></a>01648 <span class="comment"></span>
<a name="l01649"></a>01649 <span class="comment">                break;*/</span>
<a name="l01650"></a>01650             <span class="keywordflow">case</span> ProtocolInfo::ANIMATE_PACKET:
<a name="l01651"></a>01651                 <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">false</span>){
<a name="l01652"></a>01652                     <span class="keywordflow">break</span>;
<a name="l01653"></a>01653                 }
<a name="l01654"></a>01654 
<a name="l01655"></a>01655                 $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev = <span class="keyword">new</span> PlayerAnimationEvent($this, $packet-&gt;action));
<a name="l01656"></a>01656                 <span class="keywordflow">if</span>($ev-&gt;isCancelled()){
<a name="l01657"></a>01657                     <span class="keywordflow">break</span>;
<a name="l01658"></a>01658                 }
<a name="l01659"></a>01659 
<a name="l01660"></a>01660                 $pk = <span class="keyword">new</span> AnimatePacket();
<a name="l01661"></a>01661                 $pk-&gt;eid = $this-&gt;getID();
<a name="l01662"></a>01662                 $pk-&gt;action = $ev-&gt;getAnimationType();
<a name="l01663"></a>01663                 $this-&gt;server-&gt;broadcastPacket($this-&gt;getViewers(), $pk);
<a name="l01664"></a>01664                 <span class="keywordflow">break</span>;
<a name="l01665"></a>01665             <span class="keywordflow">case</span> ProtocolInfo::RESPAWN_PACKET:
<a name="l01666"></a>01666                 <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">false</span> or $this-&gt;dead === <span class="keyword">false</span>){
<a name="l01667"></a>01667                     <span class="keywordflow">break</span>;
<a name="l01668"></a>01668                 }
<a name="l01669"></a>01669                 $this-&gt;craftingType = 0;
<a name="l01670"></a>01670 
<a name="l01671"></a>01671                 $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev = <span class="keyword">new</span> PlayerRespawnEvent($this, $this-&gt;spawnPosition));
<a name="l01672"></a>01672 
<a name="l01673"></a>01673                 $this-&gt;teleport($ev-&gt;getRespawnPosition());
<a name="l01674"></a>01674                 <span class="comment">//$this-&gt;entity-&gt;fire = 0;</span>
<a name="l01675"></a>01675                 <span class="comment">//$this-&gt;entity-&gt;air = 300;</span>
<a name="l01676"></a>01676                 <span class="comment">//$this-&gt;entity-&gt;setHealth(20, &quot;respawn&quot;, true);</span>
<a name="l01677"></a>01677                 <span class="comment">//$this-&gt;entity-&gt;updateMetadata();</span>
<a name="l01678"></a>01678 
<a name="l01679"></a>01679                 $this-&gt;sendSettings();
<a name="l01680"></a>01680                 $this-&gt;inventory-&gt;sendContents($this);
<a name="l01681"></a>01681                 $this-&gt;inventory-&gt;sendArmorContents($this);
<a name="l01682"></a>01682 
<a name="l01683"></a>01683                 $this-&gt;blocked = <span class="keyword">false</span>;
<a name="l01684"></a>01684                 <span class="keywordflow">break</span>;
<a name="l01685"></a>01685             <span class="keywordflow">case</span> ProtocolInfo::SET_HEALTH_PACKET: <span class="comment">//Not used</span>
<a name="l01686"></a>01686                 <span class="keywordflow">break</span>;
<a name="l01687"></a>01687             <span class="keywordflow">case</span> ProtocolInfo::ENTITY_EVENT_PACKET:
<a name="l01688"></a>01688                 <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">false</span> or $this-&gt;blocked === <span class="keyword">true</span>){
<a name="l01689"></a>01689                     <span class="keywordflow">break</span>;
<a name="l01690"></a>01690                 }
<a name="l01691"></a>01691                 $this-&gt;craftingType = 0;
<a name="l01692"></a>01692 
<a name="l01693"></a>01693                 <span class="keywordflow">if</span>($this-&gt;inAction === <span class="keyword">true</span>){
<a name="l01694"></a>01694                     $this-&gt;inAction = <span class="keyword">false</span>;
<a name="l01695"></a>01695                     <span class="comment">//$this-&gt;updateMetadata();</span>
<a name="l01696"></a>01696                 }
<a name="l01697"></a>01697                 <span class="keywordflow">switch</span>($packet-&gt;event){
<a name="l01698"></a>01698                     <span class="keywordflow">case</span> 9: <span class="comment">//Eating</span>
<a name="l01699"></a>01699                         $items = array(
<a name="l01700"></a>01700                             Item::APPLE =&gt; 4,
<a name="l01701"></a>01701                             Item::MUSHROOM_STEW =&gt; 10,
<a name="l01702"></a>01702                             Item::BEETROOT_SOUP =&gt; 10,
<a name="l01703"></a>01703                             Item::BREAD =&gt; 5,
<a name="l01704"></a>01704                             Item::RAW_PORKCHOP =&gt; 3,
<a name="l01705"></a>01705                             Item::COOKED_PORKCHOP =&gt; 8,
<a name="l01706"></a>01706                             Item::RAW_BEEF =&gt; 3,
<a name="l01707"></a>01707                             Item::STEAK =&gt; 8,
<a name="l01708"></a>01708                             Item::COOKED_CHICKEN =&gt; 6,
<a name="l01709"></a>01709                             Item::RAW_CHICKEN =&gt; 2,
<a name="l01710"></a>01710                             Item::MELON_SLICE =&gt; 2,
<a name="l01711"></a>01711                             Item::GOLDEN_APPLE =&gt; 10,
<a name="l01712"></a>01712                             Item::PUMPKIN_PIE =&gt; 8,
<a name="l01713"></a>01713                             Item::CARROT =&gt; 4,
<a name="l01714"></a>01714                             Item::POTATO =&gt; 1,
<a name="l01715"></a>01715                             Item::BAKED_POTATO =&gt; 6,
<a name="l01716"></a>01716                             <span class="comment">//Item::COOKIE =&gt; 2,</span>
<a name="l01717"></a>01717                             <span class="comment">//Item::COOKED_FISH =&gt; 5,</span>
<a name="l01718"></a>01718                             <span class="comment">//Item::RAW_FISH =&gt; 2,</span>
<a name="l01719"></a>01719                         );
<a name="l01720"></a>01720                         $slot = $this-&gt;inventory-&gt;getItemInHand();
<a name="l01721"></a>01721                         <span class="keywordflow">if</span>($this-&gt;getHealth() &lt; 20 and isset($items[$slot-&gt;getID()])){
<a name="l01722"></a>01722                             $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev = <span class="keyword">new</span> PlayerItemConsumeEvent($this, $slot));
<a name="l01723"></a>01723                             <span class="keywordflow">if</span>($ev-&gt;isCancelled()){
<a name="l01724"></a>01724                                 $this-&gt;inventory-&gt;sendContents($this);
<a name="l01725"></a>01725                                 <span class="keywordflow">break</span>;
<a name="l01726"></a>01726                             }
<a name="l01727"></a>01727 
<a name="l01728"></a>01728                             $pk = <span class="keyword">new</span> EntityEventPacket();
<a name="l01729"></a>01729                             $pk-&gt;eid = 0;
<a name="l01730"></a>01730                             $pk-&gt;event = 9;
<a name="l01731"></a>01731                             $this-&gt;dataPacket($pk);
<a name="l01732"></a>01732                             $pk-&gt;eid = $this-&gt;getID();
<a name="l01733"></a>01733                             $this-&gt;server-&gt;broadcastPacket($this-&gt;getViewers(), $pk);
<a name="l01734"></a>01734 
<a name="l01735"></a>01735                             $this-&gt;heal($items[$slot-&gt;getID()], <span class="stringliteral">&quot;eating&quot;</span>);
<a name="l01736"></a>01736                             --$slot-&gt;count;
<a name="l01737"></a>01737                             $this-&gt;inventory-&gt;setItemInHand($slot);
<a name="l01738"></a>01738                             <span class="keywordflow">if</span>($slot-&gt;getID() === Item::MUSHROOM_STEW or $slot-&gt;getID() === Item::BEETROOT_SOUP){
<a name="l01739"></a>01739                                 $this-&gt;inventory-&gt;addItem(Item::get(Item::BOWL, 0, 1));
<a name="l01740"></a>01740                             }
<a name="l01741"></a>01741                         }
<a name="l01742"></a>01742                         <span class="keywordflow">break</span>;
<a name="l01743"></a>01743                 }
<a name="l01744"></a>01744                 <span class="keywordflow">break</span>;
<a name="l01745"></a>01745             <span class="keywordflow">case</span> ProtocolInfo::DROP_ITEM_PACKET:
<a name="l01746"></a>01746                 <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">false</span> or $this-&gt;blocked === <span class="keyword">true</span>){
<a name="l01747"></a>01747                     <span class="keywordflow">break</span>;
<a name="l01748"></a>01748                 }
<a name="l01749"></a>01749                 $packet-&gt;eid = $this-&gt;id;
<a name="l01750"></a>01750                 $item = $this-&gt;inventory-&gt;getItemInHand();
<a name="l01751"></a>01751                 $ev = <span class="keyword">new</span> PlayerDropItemEvent($this, $item);
<a name="l01752"></a>01752                 <span class="keywordflow">if</span>($this-&gt;blocked === <span class="keyword">true</span>){
<a name="l01753"></a>01753                     $ev-&gt;setCancelled(<span class="keyword">true</span>);
<a name="l01754"></a>01754                 }
<a name="l01755"></a>01755                 $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev);
<a name="l01756"></a>01756                 <span class="keywordflow">if</span>($ev-&gt;isCancelled()){
<a name="l01757"></a>01757                     $this-&gt;inventory-&gt;sendContents($this);
<a name="l01758"></a>01758                     <span class="keywordflow">break</span>;
<a name="l01759"></a>01759                 }
<a name="l01760"></a>01760 
<a name="l01761"></a>01761                 $this-&gt;inventory-&gt;setItemInHand(Item::get(Item::AIR, 0, 0));
<a name="l01762"></a>01762                 $motion = $this-&gt;getDirectionVector()-&gt;multiply(10);
<a name="l01763"></a>01763 
<a name="l01764"></a>01764                 $this-&gt;getLevel()-&gt;dropItem($this-&gt;add(0, 1, 0), $item, $motion);
<a name="l01765"></a>01765 
<a name="l01766"></a>01766                 <span class="keywordflow">if</span>($this-&gt;inAction === <span class="keyword">true</span>){
<a name="l01767"></a>01767                     $this-&gt;inAction = <span class="keyword">false</span>;
<a name="l01768"></a>01768                     <span class="comment">//$this-&gt;updateMetadata();</span>
<a name="l01769"></a>01769                 }
<a name="l01770"></a>01770                 <span class="keywordflow">break</span>;
<a name="l01771"></a>01771             <span class="keywordflow">case</span> ProtocolInfo::MESSAGE_PACKET:
<a name="l01772"></a>01772                 <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">false</span>){
<a name="l01773"></a>01773                     <span class="keywordflow">break</span>;
<a name="l01774"></a>01774                 }
<a name="l01775"></a>01775                 $this-&gt;craftingType = 0;
<a name="l01776"></a>01776                 $packet-&gt;message = TextFormat::clean($packet-&gt;message);
<a name="l01777"></a>01777                 <span class="keywordflow">if</span>(trim($packet-&gt;message) != <span class="stringliteral">&quot;&quot;</span> and strlen($packet-&gt;message) &lt;= 255){
<a name="l01778"></a>01778                     $message = $packet-&gt;message;
<a name="l01779"></a>01779                     $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev = <span class="keyword">new</span> PlayerCommandPreprocessEvent($this, $message));
<a name="l01780"></a>01780                     <span class="keywordflow">if</span>($ev-&gt;isCancelled()){
<a name="l01781"></a>01781                         <span class="keywordflow">break</span>;
<a name="l01782"></a>01782                     }
<a name="l01783"></a>01783                     <span class="keywordflow">if</span>(substr($ev-&gt;getMessage(), 0, 1) === <span class="stringliteral">&quot;/&quot;</span>){ <span class="comment">//Command</span>
<a name="l01784"></a>01784                         $this-&gt;server-&gt;dispatchCommand($ev-&gt;getPlayer(), substr($ev-&gt;getMessage(), 1));
<a name="l01785"></a>01785                     }<span class="keywordflow">else</span>{
<a name="l01786"></a>01786                         $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev = <span class="keyword">new</span> PlayerChatEvent($this, $ev-&gt;getMessage()));
<a name="l01787"></a>01787                         <span class="keywordflow">if</span>(!$ev-&gt;isCancelled()){
<a name="l01788"></a>01788                             $this-&gt;server-&gt;broadcastMessage(sprintf($ev-&gt;getFormat(), $ev-&gt;getPlayer()-&gt;getDisplayName(), $ev-&gt;getMessage()), $ev-&gt;getRecipients());
<a name="l01789"></a>01789                         }
<a name="l01790"></a>01790                     }
<a name="l01791"></a>01791                 }
<a name="l01792"></a>01792                 <span class="keywordflow">break</span>;
<a name="l01793"></a>01793             <span class="keywordflow">case</span> ProtocolInfo::CONTAINER_CLOSE_PACKET:
<a name="l01794"></a>01794                 <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">false</span> or $packet-&gt;windowid === 0){
<a name="l01795"></a>01795                     <span class="keywordflow">break</span>;
<a name="l01796"></a>01796                 }
<a name="l01797"></a>01797                 $this-&gt;craftingType = 0;
<a name="l01798"></a>01798                 $this-&gt;currentTransaction = null;
<a name="l01799"></a>01799                 <span class="keywordflow">if</span>(isset($this-&gt;windowIndex[$packet-&gt;windowid])){
<a name="l01800"></a>01800                     $this-&gt;server-&gt;getPluginManager()-&gt;callEvent(<span class="keyword">new</span> InventoryCloseEvent($this-&gt;windowIndex[$packet-&gt;windowid], $this));
<a name="l01801"></a>01801                     $this-&gt;removeWindow($this-&gt;windowIndex[$packet-&gt;windowid]);
<a name="l01802"></a>01802                 }<span class="keywordflow">else</span>{
<a name="l01803"></a>01803                     unset($this-&gt;windowIndex[$packet-&gt;windowid]);
<a name="l01804"></a>01804                 }
<a name="l01805"></a>01805                 <span class="keywordflow">break</span>;
<a name="l01806"></a>01806             <span class="keywordflow">case</span> ProtocolInfo::CONTAINER_SET_SLOT_PACKET:
<a name="l01807"></a>01807                 <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">false</span> or $this-&gt;blocked === <span class="keyword">true</span>){
<a name="l01808"></a>01808                     <span class="keywordflow">break</span>;
<a name="l01809"></a>01809                 }
<a name="l01810"></a>01810 
<a name="l01811"></a>01811                 <span class="keywordflow">if</span>($packet-&gt;slot &lt; 0){
<a name="l01812"></a>01812                     <span class="keywordflow">break</span>;
<a name="l01813"></a>01813                 }
<a name="l01814"></a>01814 
<a name="l01815"></a>01815                 <span class="keywordflow">if</span>($packet-&gt;windowid === 0){ <span class="comment">//Our inventory</span>
<a name="l01816"></a>01816                     <span class="keywordflow">if</span>($packet-&gt;slot &gt; $this-&gt;inventory-&gt;getSize()){
<a name="l01817"></a>01817                         <span class="keywordflow">break</span>;
<a name="l01818"></a>01818                     }
<a name="l01819"></a>01819                     $transaction = <span class="keyword">new</span> BaseTransaction($this-&gt;inventory, $packet-&gt;slot, $this-&gt;inventory-&gt;getItem($packet-&gt;slot), $packet-&gt;item);
<a name="l01820"></a>01820                 }elseif(isset($this-&gt;windowIndex[$packet-&gt;windowid])){
<a name="l01821"></a>01821                     $this-&gt;craftingType = 0;
<a name="l01822"></a>01822                     $inv = $this-&gt;windowIndex[$packet-&gt;windowid];
<a name="l01823"></a>01823                     $transaction = <span class="keyword">new</span> BaseTransaction($inv, $packet-&gt;slot, $inv-&gt;getItem($packet-&gt;slot), $packet-&gt;item);
<a name="l01824"></a>01824                 }<span class="keywordflow">else</span>{
<a name="l01825"></a>01825                     <span class="keywordflow">break</span>;
<a name="l01826"></a>01826                 }
<a name="l01827"></a>01827 
<a name="l01828"></a>01828                 <span class="keywordflow">if</span>($transaction-&gt;getSourceItem()-&gt;equals($transaction-&gt;getTargetItem(), <span class="keyword">true</span>) and $transaction-&gt;getTargetItem()-&gt;getCount() === $transaction-&gt;getSourceItem()-&gt;getCount()){ <span class="comment">//No changes!</span>
<a name="l01829"></a>01829                     <span class="comment">//No changes, just a local inventory update sent by the server</span>
<a name="l01830"></a>01830                     <span class="keywordflow">break</span>;
<a name="l01831"></a>01831                 }
<a name="l01832"></a>01832 
<a name="l01833"></a>01833 
<a name="l01834"></a>01834                 <span class="keywordflow">if</span>($this-&gt;currentTransaction === null or $this-&gt;currentTransaction-&gt;getCreationTime() &lt; (microtime(<span class="keyword">true</span>) - 0.4)){
<a name="l01835"></a>01835                     <span class="keywordflow">if</span>($this-&gt;currentTransaction instanceof SimpleTransactionGroup){
<a name="l01836"></a>01836                         <span class="keywordflow">foreach</span>($this-&gt;currentTransaction-&gt;getInventories() as $inventory){
<a name="l01837"></a>01837                             $inventory-&gt;sendContents($inventory-&gt;getViewers());
<a name="l01838"></a>01838                         }
<a name="l01839"></a>01839                     }
<a name="l01840"></a>01840                     $this-&gt;currentTransaction = <span class="keyword">new</span> SimpleTransactionGroup($this);
<a name="l01841"></a>01841                 }
<a name="l01842"></a>01842 
<a name="l01843"></a>01843                 $this-&gt;currentTransaction-&gt;addTransaction($transaction);
<a name="l01844"></a>01844 
<a name="l01845"></a>01845                 <span class="keywordflow">if</span>($this-&gt;currentTransaction-&gt;canExecute()){
<a name="l01846"></a>01846                     <span class="keywordflow">if</span>(!$this-&gt;currentTransaction-&gt;execute()){
<a name="l01847"></a>01847                         $this-&gt;currentTransaction = null;
<a name="l01848"></a>01848                         <span class="keywordflow">break</span>;
<a name="l01849"></a>01849                     }
<a name="l01850"></a>01850 
<a name="l01851"></a>01851                     <span class="keywordflow">foreach</span>($this-&gt;currentTransaction-&gt;getTransactions() as $ts){
<a name="l01852"></a>01852                         $inv = $ts-&gt;getInventory();
<a name="l01853"></a>01853                         <span class="keywordflow">if</span>($inv instanceof FurnaceInventory){
<a name="l01854"></a>01854                             <span class="keywordflow">if</span>($ts-&gt;getSlot() === 2){
<a name="l01855"></a>01855                                 <span class="keywordflow">switch</span>($inv-&gt;getResult()){
<a name="l01856"></a>01856                                     <span class="keywordflow">case</span> Item::IRON_INGOT:
<a name="l01857"></a>01857                                         $this-&gt;awardAchievement(<span class="stringliteral">&quot;acquireIron&quot;</span>);
<a name="l01858"></a>01858                                         <span class="keywordflow">break</span>;
<a name="l01859"></a>01859                                 }
<a name="l01860"></a>01860                             }
<a name="l01861"></a>01861                         }
<a name="l01862"></a>01862                     }
<a name="l01863"></a>01863 
<a name="l01864"></a>01864                     $this-&gt;currentTransaction = null;
<a name="l01865"></a>01865                 }elseif($packet-&gt;windowid == 0){ <span class="comment">//Try crafting</span>
<a name="l01866"></a>01866                     $craftingGroup = <span class="keyword">new</span> CraftingTransactionGroup($this-&gt;currentTransaction);
<a name="l01867"></a>01867                     <span class="keywordflow">if</span>($craftingGroup-&gt;canExecute()){ <span class="comment">//We can craft!</span>
<a name="l01868"></a>01868                         $recipe = $craftingGroup-&gt;getMatchingRecipe();
<a name="l01869"></a>01869                         <span class="keywordflow">if</span>($recipe instanceof BigShapelessRecipe and $this-&gt;craftingType !== 1){
<a name="l01870"></a>01870                             <span class="keywordflow">break</span>;
<a name="l01871"></a>01871                         }elseif($recipe instanceof StonecutterShapelessRecipe and $this-&gt;craftingType !== 2){
<a name="l01872"></a>01872                             <span class="keywordflow">break</span>;
<a name="l01873"></a>01873                         }
<a name="l01874"></a>01874 
<a name="l01875"></a>01875                         <span class="keywordflow">if</span>($craftingGroup-&gt;execute()){
<a name="l01876"></a>01876                             <span class="keywordflow">switch</span>($craftingGroup-&gt;getResult()-&gt;getID()){
<a name="l01877"></a>01877                                 <span class="keywordflow">case</span> Item::WORKBENCH:
<a name="l01878"></a>01878                                     $this-&gt;awardAchievement(<span class="stringliteral">&quot;buildWorkBench&quot;</span>);
<a name="l01879"></a>01879                                     <span class="keywordflow">break</span>;
<a name="l01880"></a>01880                                 <span class="keywordflow">case</span> Item::WOODEN_PICKAXE:
<a name="l01881"></a>01881                                     $this-&gt;awardAchievement(<span class="stringliteral">&quot;buildPickaxe&quot;</span>);
<a name="l01882"></a>01882                                     <span class="keywordflow">break</span>;
<a name="l01883"></a>01883                                 <span class="keywordflow">case</span> Item::FURNACE:
<a name="l01884"></a>01884                                     $this-&gt;awardAchievement(<span class="stringliteral">&quot;buildFurnace&quot;</span>);
<a name="l01885"></a>01885                                     <span class="keywordflow">break</span>;
<a name="l01886"></a>01886                                 <span class="keywordflow">case</span> Item::WOODEN_HOE:
<a name="l01887"></a>01887                                     $this-&gt;awardAchievement(<span class="stringliteral">&quot;buildHoe&quot;</span>);
<a name="l01888"></a>01888                                     <span class="keywordflow">break</span>;
<a name="l01889"></a>01889                                 <span class="keywordflow">case</span> Item::BREAD:
<a name="l01890"></a>01890                                     $this-&gt;awardAchievement(<span class="stringliteral">&quot;makeBread&quot;</span>);
<a name="l01891"></a>01891                                     <span class="keywordflow">break</span>;
<a name="l01892"></a>01892                                 <span class="keywordflow">case</span> Item::CAKE:
<a name="l01893"></a>01893                                     <span class="comment">//TODO: detect complex recipes like cake that leave remainings</span>
<a name="l01894"></a>01894                                     $this-&gt;awardAchievement(<span class="stringliteral">&quot;bakeCake&quot;</span>);
<a name="l01895"></a>01895                                     $this-&gt;inventory-&gt;addItem(Item::get(Item::BUCKET, 0, 3));
<a name="l01896"></a>01896                                     <span class="keywordflow">break</span>;
<a name="l01897"></a>01897                                 <span class="keywordflow">case</span> Item::STONE_PICKAXE:
<a name="l01898"></a>01898                                 <span class="keywordflow">case</span> Item::GOLD_PICKAXE:
<a name="l01899"></a>01899                                 <span class="keywordflow">case</span> Item::IRON_PICKAXE:
<a name="l01900"></a>01900                                 <span class="keywordflow">case</span> Item::DIAMOND_PICKAXE:
<a name="l01901"></a>01901                                     $this-&gt;awardAchievement(<span class="stringliteral">&quot;buildBetterPickaxe&quot;</span>);
<a name="l01902"></a>01902                                     <span class="keywordflow">break</span>;
<a name="l01903"></a>01903                                 <span class="keywordflow">case</span> Item::WOODEN_SWORD:
<a name="l01904"></a>01904                                     $this-&gt;awardAchievement(<span class="stringliteral">&quot;buildSword&quot;</span>);
<a name="l01905"></a>01905                                     <span class="keywordflow">break</span>;
<a name="l01906"></a>01906                                 <span class="keywordflow">case</span> Item::DIAMOND:
<a name="l01907"></a>01907                                     $this-&gt;awardAchievement(<span class="stringliteral">&quot;diamond&quot;</span>);
<a name="l01908"></a>01908                                     <span class="keywordflow">break</span>;
<a name="l01909"></a>01909                             }
<a name="l01910"></a>01910                         }
<a name="l01911"></a>01911 
<a name="l01912"></a>01912 
<a name="l01913"></a>01913                         $this-&gt;currentTransaction = null;
<a name="l01914"></a>01914                     }
<a name="l01915"></a>01915 
<a name="l01916"></a>01916 
<a name="l01917"></a>01917                 }
<a name="l01918"></a>01918 
<a name="l01919"></a>01919 
<a name="l01920"></a>01920                 <span class="keywordflow">break</span>;
<a name="l01921"></a>01921             <span class="keywordflow">case</span> ProtocolInfo::SEND_INVENTORY_PACKET: <span class="comment">//TODO, Mojang, enable this ^_^`</span>
<a name="l01922"></a>01922                 <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">false</span>){
<a name="l01923"></a>01923                     <span class="keywordflow">break</span>;
<a name="l01924"></a>01924                 }
<a name="l01925"></a>01925                 <span class="keywordflow">break</span>;
<a name="l01926"></a>01926             <span class="keywordflow">case</span> ProtocolInfo::ENTITY_DATA_PACKET:
<a name="l01927"></a>01927                 <span class="keywordflow">if</span>($this-&gt;spawned === <span class="keyword">false</span> or $this-&gt;blocked === <span class="keyword">true</span>){
<a name="l01928"></a>01928                     <span class="keywordflow">break</span>;
<a name="l01929"></a>01929                 }
<a name="l01930"></a>01930                 $this-&gt;craftingType = 0;
<a name="l01931"></a>01931 
<a name="l01932"></a>01932                 $t = $this-&gt;getLevel()-&gt;getTile(<span class="keyword">new</span> Vector3($packet-&gt;x, $packet-&gt;y, $packet-&gt;z));
<a name="l01933"></a>01933                 <span class="keywordflow">if</span>($t instanceof Sign){
<a name="l01934"></a>01934                     <span class="keywordflow">if</span>(!isset($t-&gt;namedtag-&gt;Creator) or $t-&gt;namedtag[<span class="stringliteral">&quot;Creator&quot;</span>] !== $this-&gt;username){
<a name="l01935"></a>01935                         $t-&gt;spawnTo($this);
<a name="l01936"></a>01936                     }<span class="keywordflow">else</span>{
<a name="l01937"></a>01937                         $nbt = <span class="keyword">new</span> NBT(NBT::LITTLE_ENDIAN);
<a name="l01938"></a>01938                         $nbt-&gt;read($packet-&gt;namedtag);
<a name="l01939"></a>01939                         $nbt = $nbt-&gt;getData();
<a name="l01940"></a>01940                         <span class="keywordflow">if</span>($nbt[<span class="stringliteral">&quot;id&quot;</span>] !== Tile::SIGN){
<a name="l01941"></a>01941                             $t-&gt;spawnTo($this);
<a name="l01942"></a>01942                         }<span class="keywordflow">else</span>{
<a name="l01943"></a>01943                             $t-&gt;setText($nbt[<span class="stringliteral">&quot;Text1&quot;</span>], $nbt[<span class="stringliteral">&quot;Text2&quot;</span>], $nbt[<span class="stringliteral">&quot;Text3&quot;</span>], $nbt[<span class="stringliteral">&quot;Text4&quot;</span>]);
<a name="l01944"></a>01944                         }
<a name="l01945"></a>01945                     }
<a name="l01946"></a>01946                 }
<a name="l01947"></a>01947                 <span class="keywordflow">break</span>;
<a name="l01948"></a>01948             <span class="keywordflow">default</span>:
<a name="l01949"></a>01949                 $this-&gt;server-&gt;getLogger()-&gt;debug(<span class="stringliteral">&quot;Unhandled &quot;</span> . $packet-&gt;pid() . <span class="stringliteral">&quot; data packet for &quot;</span> . $this-&gt;username . <span class="stringliteral">&quot; (&quot;</span> . $this-&gt;clientID . <span class="stringliteral">&quot;): &quot;</span> . print_r($packet, <span class="keyword">true</span>));
<a name="l01950"></a>01950                 <span class="keywordflow">break</span>;
<a name="l01951"></a>01951         }
<a name="l01952"></a>01952     }
<a name="l01953"></a>01953 
<a name="l01961"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#af2abb8b3975a8ce2a37ee26022920396">01961</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#af2abb8b3975a8ce2a37ee26022920396">kick</a>($reason = <span class="stringliteral">&quot;&quot;</span>){
<a name="l01962"></a>01962         $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev = <span class="keyword">new</span> PlayerKickEvent($this, $reason, TextFormat::YELLOW . $this-&gt;username . <span class="stringliteral">&quot; has left the game&quot;</span>));
<a name="l01963"></a>01963         <span class="keywordflow">if</span>(!$ev-&gt;isCancelled()){
<a name="l01964"></a>01964             $message = <span class="stringliteral">&quot;Kicked by admin.&quot;</span>. ($reason !== <span class="stringliteral">&quot;&quot;</span> ? <span class="stringliteral">&quot; Reason: &quot;</span>. $reason : <span class="stringliteral">&quot;&quot;</span>);
<a name="l01965"></a>01965             $this-&gt;sendMessage($message);
<a name="l01966"></a>01966             $this-&gt;close($ev-&gt;getQuitMessage(), $message);
<a name="l01967"></a>01967 
<a name="l01968"></a>01968             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01969"></a>01969         }
<a name="l01970"></a>01970 
<a name="l01971"></a>01971         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01972"></a>01972     }
<a name="l01973"></a>01973 
<a name="l01979"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a11b329b6a29f6499ef382e068080c69e">01979</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a11b329b6a29f6499ef382e068080c69e">sendMessage</a>($message){
<a name="l01980"></a>01980         $mes = explode(<span class="stringliteral">&quot;\n&quot;</span>, $message);
<a name="l01981"></a>01981         <span class="keywordflow">foreach</span>($mes as $m){
<a name="l01982"></a>01982             <span class="keywordflow">if</span>(preg_match_all(<span class="stringliteral">&#39;#@([@A-Za-z_]{1,})#&#39;</span>, $m, $matches, PREG_OFFSET_CAPTURE) &gt; 0){
<a name="l01983"></a>01983                 $offsetshift = 0;
<a name="l01984"></a>01984                 <span class="keywordflow">foreach</span>($matches[1] as $selector){
<a name="l01985"></a>01985                     <span class="keywordflow">if</span>($selector[0]{0} === <span class="stringliteral">&quot;@&quot;</span>){ <span class="comment">//Escape!</span>
<a name="l01986"></a>01986                         $m = substr_replace($m, $selector[0], $selector[1] + $offsetshift - 1, strlen($selector[0]) + 1);
<a name="l01987"></a>01987                         --$offsetshift;
<a name="l01988"></a>01988                         <span class="keywordflow">continue</span>;
<a name="l01989"></a>01989                     }
<a name="l01990"></a>01990                     <span class="keywordflow">switch</span>(strtolower($selector[0])){
<a name="l01991"></a>01991                         <span class="keywordflow">case</span> <span class="stringliteral">&quot;player&quot;</span>:
<a name="l01992"></a>01992                         <span class="keywordflow">case</span> <span class="stringliteral">&quot;username&quot;</span>:
<a name="l01993"></a>01993                             $m = substr_replace($m, $this-&gt;username, $selector[1] + $offsetshift - 1, strlen($selector[0]) + 1);
<a name="l01994"></a>01994                             $offsetshift += strlen($selector[0]) - strlen($this-&gt;username) + 1;
<a name="l01995"></a>01995                             <span class="keywordflow">break</span>;
<a name="l01996"></a>01996                     }
<a name="l01997"></a>01997                 }
<a name="l01998"></a>01998             }
<a name="l01999"></a>01999 
<a name="l02000"></a>02000             <span class="keywordflow">if</span>($m !== <span class="stringliteral">&quot;&quot;</span>){
<a name="l02001"></a>02001                 $pk = <span class="keyword">new</span> MessagePacket;
<a name="l02002"></a>02002                 $pk-&gt;source = <span class="stringliteral">&quot;&quot;</span>; <span class="comment">//Do not use this ;)</span>
<a name="l02003"></a>02003                 $pk-&gt;message = $this-&gt;removeFormat === <span class="keyword">false</span> ? $m : TextFormat::clean($m);
<a name="l02004"></a>02004                 $this-&gt;dataPacket($pk);
<a name="l02005"></a>02005             }
<a name="l02006"></a>02006         }
<a name="l02007"></a>02007     }
<a name="l02008"></a>02008 
<a name="l02013"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a3684d481cd56f1cf6efa1418f1ed9b34">02013</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a3684d481cd56f1cf6efa1418f1ed9b34">close</a>($message = <span class="stringliteral">&quot;&quot;</span>, $reason = <span class="stringliteral">&quot;generic reason&quot;</span>){
<a name="l02014"></a>02014         <span class="keywordflow">if</span>($this-&gt;connected === <span class="keyword">true</span>){
<a name="l02015"></a>02015             <span class="keywordflow">if</span>($this-&gt;username != <span class="stringliteral">&quot;&quot;</span>){
<a name="l02016"></a>02016                 $this-&gt;server-&gt;getPluginManager()-&gt;callEvent($ev = <span class="keyword">new</span> PlayerQuitEvent($this, $message));
<a name="l02017"></a>02017                 <span class="keywordflow">if</span>($this-&gt;loggedIn === <span class="keyword">true</span>){
<a name="l02018"></a>02018                     parent::close();
<a name="l02019"></a>02019                     $this-&gt;save();
<a name="l02020"></a>02020                 }
<a name="l02021"></a>02021             }
<a name="l02022"></a>02022 
<a name="l02023"></a>02023             $this-&gt;connected = <span class="keyword">false</span>;
<a name="l02024"></a>02024             $this-&gt;interface-&gt;close($this, $reason);
<a name="l02025"></a>02025             $this-&gt;server-&gt;removePlayer($this);
<a name="l02026"></a>02026             $this-&gt;getLevel()-&gt;freeAllChunks($this);
<a name="l02027"></a>02027             $this-&gt;loggedIn = <span class="keyword">false</span>;
<a name="l02028"></a>02028             <span class="keywordflow">foreach</span>($this-&gt;tasks as $task){
<a name="l02029"></a>02029                 $task-&gt;cancel();
<a name="l02030"></a>02030             }
<a name="l02031"></a>02031             $this-&gt;tasks = [];
<a name="l02032"></a>02032 
<a name="l02033"></a>02033             <span class="keywordflow">if</span>(isset($ev) and $this-&gt;username != <span class="stringliteral">&quot;&quot;</span> and $this-&gt;spawned !== <span class="keyword">false</span> and $ev-&gt;getQuitMessage() != <span class="stringliteral">&quot;&quot;</span>){
<a name="l02034"></a>02034                 $this-&gt;server-&gt;broadcastMessage($ev-&gt;getQuitMessage());
<a name="l02035"></a>02035             }
<a name="l02036"></a>02036             $this-&gt;server-&gt;getPluginManager()-&gt;unsubscribeFromPermission(Server::BROADCAST_CHANNEL_USERS, $this);
<a name="l02037"></a>02037             $this-&gt;spawned = <span class="keyword">false</span>;
<a name="l02038"></a>02038             $this-&gt;server-&gt;getLogger()-&gt;info(TextFormat::AQUA . $this-&gt;username . TextFormat::WHITE . <span class="stringliteral">&quot;[/&quot;</span> . $this-&gt;ip . <span class="stringliteral">&quot;:&quot;</span> . $this-&gt;port . <span class="stringliteral">&quot;] logged out due to &quot;</span> . str_replace([<span class="stringliteral">&quot;\n&quot;</span>, <span class="stringliteral">&quot;\r&quot;</span>], [<span class="stringliteral">&quot; &quot;</span>, <span class="stringliteral">&quot;&quot;</span>], $reason));
<a name="l02039"></a>02039             $this-&gt;windows = new \SplObjectStorage();
<a name="l02040"></a>02040             $this-&gt;windowIndex = [];
<a name="l02041"></a>02041             $this-&gt;usedChunks = [];
<a name="l02042"></a>02042             $this-&gt;loadQueue = [];
<a name="l02043"></a>02043             unset($this-&gt;buffer);
<a name="l02044"></a>02044         }
<a name="l02045"></a>02045     }
<a name="l02046"></a>02046 
<a name="l02050"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a5ca632b75ba3c04f5964e5092b38032e">02050</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a5ca632b75ba3c04f5964e5092b38032e">save</a>(){
<a name="l02051"></a>02051         parent::saveNBT();
<a name="l02052"></a>02052         $this-&gt;namedtag[<span class="stringliteral">&quot;Level&quot;</span>] = $this-&gt;getLevel()-&gt;getName();
<a name="l02053"></a>02053         $this-&gt;namedtag[<span class="stringliteral">&quot;SpawnLevel&quot;</span>] = $this-&gt;getLevel()-&gt;getName();
<a name="l02054"></a>02054         $this-&gt;namedtag[<span class="stringliteral">&quot;SpawnX&quot;</span>] = (int) $this-&gt;spawnPosition-&gt;x;
<a name="l02055"></a>02055         $this-&gt;namedtag[<span class="stringliteral">&quot;SpawnY&quot;</span>] = (<span class="keywordtype">int</span>) $this-&gt;spawnPosition-&gt;y;
<a name="l02056"></a>02056         $this-&gt;namedtag[<span class="stringliteral">&quot;SpawnZ&quot;</span>] = (int) $this-&gt;spawnPosition-&gt;z;
<a name="l02057"></a>02057 
<a name="l02058"></a>02058         <span class="keywordflow">foreach</span>($this-&gt;achievements as $achievement =&gt; $status){
<a name="l02059"></a>02059             $this-&gt;namedtag-&gt;Achievements[$achievement] = <span class="keyword">new</span> Byte($achievement, $status === <span class="keyword">true</span> ? 1 : 0);
<a name="l02060"></a>02060         }
<a name="l02061"></a>02061 
<a name="l02062"></a>02062         $this-&gt;namedtag[<span class="stringliteral">&quot;playerGameType&quot;</span>] = $this-&gt;gamemode;
<a name="l02063"></a>02063         $this-&gt;namedtag[<span class="stringliteral">&quot;lastPlayed&quot;</span>] = floor(microtime(<span class="keyword">true</span>) * 1000);
<a name="l02064"></a>02064 
<a name="l02065"></a>02065         <span class="comment">//$this-&gt;data-&gt;set(&quot;health&quot;, $this-&gt;getHealth());</span>
<a name="l02066"></a>02066 
<a name="l02067"></a>02067         <span class="keywordflow">if</span>($this-&gt;username != <span class="stringliteral">&quot;&quot;</span> and $this-&gt;isOnline() and $this-&gt;namedtag instanceof Compound){
<a name="l02068"></a>02068             $this-&gt;server-&gt;saveOfflinePlayerData($this-&gt;username, $this-&gt;namedtag);
<a name="l02069"></a>02069         }
<a name="l02070"></a>02070     }
<a name="l02071"></a>02071 
<a name="l02077"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a890409beec631f5cbc42d602ad94eb2b">02077</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#a890409beec631f5cbc42d602ad94eb2b">getName</a>(){
<a name="l02078"></a>02078         <span class="keywordflow">return</span> $this-&gt;username;
<a name="l02079"></a>02079     }
<a name="l02080"></a>02080 
<a name="l02081"></a>02081 
<a name="l02087"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ab6f53e7a66f91513248608f9823e7bef">02087</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#ab6f53e7a66f91513248608f9823e7bef">getWindowId</a>(Inventory $inventory){
<a name="l02088"></a>02088         <span class="keywordflow">if</span>($this-&gt;windows-&gt;contains($inventory)){
<a name="l02089"></a>02089             <span class="keywordflow">return</span> $this-&gt;windows[$inventory];
<a name="l02090"></a>02090         }
<a name="l02091"></a>02091 
<a name="l02092"></a>02092         <span class="keywordflow">return</span> -1;
<a name="l02093"></a>02093     }
<a name="l02094"></a>02094 
<a name="l02103"></a><a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#abbb921d948b40349700ab6f956e80f67">02103</a>     <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../df/d2c/classpocketmine_1_1_player.html#abbb921d948b40349700ab6f956e80f67">addWindow</a>(Inventory $inventory, $forceId = null){
<a name="l02104"></a>02104         <span class="keywordflow">if</span>($this-&gt;windows-&gt;contains($inventory)){
<a name="l02105"></a>02105             <span class="keywordflow">return</span> $this-&gt;windows[$inventory];
<a name="l02106"></a>02106         }
<a name="l02107"></a>02107 
<a name="l02108"></a>02108         <span class="keywordflow">if</span>($forceId === null){
<a name="l02109"></a>02109             $this-&gt;windowCnt = $cnt = max(2, ++$this-&gt;windowCnt % 99);
<a name="l02110"></a>02110         }<span class="keywordflow">else</span>{
<a name="l02111"></a>02111             $cnt = (int) $forceId;
<a name="l02112"></a>02112         }
<a name="l02113"></a>02113         $this-&gt;windowIndex[$cnt] = $inventory;
<a name="l02114"></a>02114         $this-&gt;windows-&gt;attach($inventory, $cnt);
<a name="l02115"></a>02115         <span class="keywordflow">if</span>($inventory-&gt;open($this)){
<a name="l02116"></a>02116             <span class="keywordflow">return</span> $cnt;
<a name="l02117"></a>02117         }<span class="keywordflow">else</span>{
<a name="l02118"></a>02118             $this-&gt;removeWindow($inventory);
<a name="l02119"></a>02119 
<a name="l02120"></a>02120             <span class="keywordflow">return</span> -1;
<a name="l02121"></a>02121         }
<a name="l02122"></a>02122     }
<a name="l02123"></a>02123 
<a name="l02124"></a>02124     <span class="keyword">public</span> <span class="keyword">function</span> removeWindow(Inventory $inventory){
<a name="l02125"></a>02125         $inventory-&gt;close($this);
<a name="l02126"></a>02126         <span class="keywordflow">if</span>($this-&gt;windows-&gt;contains($inventory)){
<a name="l02127"></a>02127             $id = $this-&gt;windows[$inventory];
<a name="l02128"></a>02128             $this-&gt;windows-&gt;detach($this-&gt;windowIndex[$id]);
<a name="l02129"></a>02129             unset($this-&gt;windowIndex[$id]);
<a name="l02130"></a>02130         }
<a name="l02131"></a>02131     }
<a name="l02132"></a>02132 
<a name="l02133"></a>02133     <span class="keyword">public</span> <span class="keyword">function</span> setMetadata($metadataKey, MetadataValue $metadataValue){
<a name="l02134"></a>02134         $this-&gt;server-&gt;getPlayerMetadata()-&gt;setMetadata($this, $metadataKey, $metadataValue);
<a name="l02135"></a>02135     }
<a name="l02136"></a>02136 
<a name="l02137"></a>02137     <span class="keyword">public</span> <span class="keyword">function</span> getMetadata($metadataKey){
<a name="l02138"></a>02138         <span class="keywordflow">return</span> $this-&gt;server-&gt;getPlayerMetadata()-&gt;getMetadata($this, $metadataKey);
<a name="l02139"></a>02139     }
<a name="l02140"></a>02140 
<a name="l02141"></a>02141     <span class="keyword">public</span> <span class="keyword">function</span> hasMetadata($metadataKey){
<a name="l02142"></a>02142         <span class="keywordflow">return</span> $this-&gt;server-&gt;getPlayerMetadata()-&gt;hasMetadata($this, $metadataKey);
<a name="l02143"></a>02143     }
<a name="l02144"></a>02144 
<a name="l02145"></a>02145     <span class="keyword">public</span> <span class="keyword">function</span> removeMetadata($metadataKey, Plugin $plugin){
<a name="l02146"></a>02146         $this-&gt;server-&gt;getPlayerMetadata()-&gt;removeMetadata($this, $metadataKey, $plugin);
<a name="l02147"></a>02147     }
<a name="l02148"></a>02148 
<a name="l02149"></a>02149 
<a name="l02150"></a>02150 }
<a name="l02151"></a>02151 
<a name="l02152"></a>02152 
<a name="l02153"></a>02153 <span class="comment">/*</span>
<a name="l02154"></a>02154 <span class="comment"> * TODO death reasons</span>
<a name="l02155"></a>02155 <span class="comment">if(is_numeric($data[&quot;cause&quot;])){</span>
<a name="l02156"></a>02156 <span class="comment">    $e = Entity::get($data[&quot;cause&quot;]);</span>
<a name="l02157"></a>02157 <span class="comment">    if($e instanceof Entity){</span>
<a name="l02158"></a>02158 <span class="comment">        switch($e-&gt;class){</span>
<a name="l02159"></a>02159 <span class="comment">            case ENTITY_PLAYER:</span>
<a name="l02160"></a>02160 <span class="comment">                $message = &quot; was killed by &quot; . $e-&gt;name;</span>
<a name="l02161"></a>02161 <span class="comment">                break;</span>
<a name="l02162"></a>02162 <span class="comment">            default:</span>
<a name="l02163"></a>02163 <span class="comment">                $message = &quot; was killed&quot;;</span>
<a name="l02164"></a>02164 <span class="comment">                break;</span>
<a name="l02165"></a>02165 <span class="comment">        }</span>
<a name="l02166"></a>02166 <span class="comment">    }</span>
<a name="l02167"></a>02167 <span class="comment">}else{</span>
<a name="l02168"></a>02168 <span class="comment">    switch($data[&quot;cause&quot;]){</span>
<a name="l02169"></a>02169 <span class="comment">        case &quot;cactus&quot;:</span>
<a name="l02170"></a>02170 <span class="comment">            $message = &quot; was pricked to death&quot;;</span>
<a name="l02171"></a>02171 <span class="comment">            break;</span>
<a name="l02172"></a>02172 <span class="comment">        case &quot;lava&quot;:</span>
<a name="l02173"></a>02173 <span class="comment">            $message = &quot; tried to swim in lava&quot;;</span>
<a name="l02174"></a>02174 <span class="comment">            break;</span>
<a name="l02175"></a>02175 <span class="comment">        case &quot;fire&quot;:</span>
<a name="l02176"></a>02176 <span class="comment">            $message = &quot; went up in flames&quot;;</span>
<a name="l02177"></a>02177 <span class="comment">            break;</span>
<a name="l02178"></a>02178 <span class="comment">        case &quot;burning&quot;:</span>
<a name="l02179"></a>02179 <span class="comment">            $message = &quot; burned to death&quot;;</span>
<a name="l02180"></a>02180 <span class="comment">            break;</span>
<a name="l02181"></a>02181 <span class="comment">        case &quot;suffocation&quot;:</span>
<a name="l02182"></a>02182 <span class="comment">            $message = &quot; suffocated in a wall&quot;;</span>
<a name="l02183"></a>02183 <span class="comment">            break;</span>
<a name="l02184"></a>02184 <span class="comment">        case &quot;water&quot;:</span>
<a name="l02185"></a>02185 <span class="comment">            $message = &quot; drowned&quot;;</span>
<a name="l02186"></a>02186 <span class="comment">            break;</span>
<a name="l02187"></a>02187 <span class="comment">        case &quot;void&quot;:</span>
<a name="l02188"></a>02188 <span class="comment">            $message = &quot; fell out of the world&quot;;</span>
<a name="l02189"></a>02189 <span class="comment">            break;</span>
<a name="l02190"></a>02190 <span class="comment">        case &quot;fall&quot;:</span>
<a name="l02191"></a>02191 <span class="comment">            $message = &quot; hit the ground too hard&quot;;</span>
<a name="l02192"></a>02192 <span class="comment">            break;</span>
<a name="l02193"></a>02193 <span class="comment">        case &quot;explosion&quot;:</span>
<a name="l02194"></a>02194 <span class="comment">            $message = &quot; blew up&quot;;</span>
<a name="l02195"></a>02195 <span class="comment">            break;</span>
<a name="l02196"></a>02196 <span class="comment">        default:</span>
<a name="l02197"></a>02197 <span class="comment">            $message = &quot; died&quot;;</span>
<a name="l02198"></a>02198 <span class="comment">            break;</span>
<a name="l02199"></a>02199 <span class="comment">    }</span>
<a name="l02200"></a>02200 <span class="comment">}</span>
<a name="l02201"></a>02201 <span class="comment">Player::broadcastMessage($data[&quot;player&quot;]-&gt;getName() . $message);</span>
<a name="l02202"></a>02202 <span class="comment">*/</span>
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><b>Player.php</b>      </li>

    <li class="footer">Generated on Thu Jul 3 2014 11:38:33 for PocketMine-MP by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
